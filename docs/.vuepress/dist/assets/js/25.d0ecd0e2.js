(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{458:function(s,t,a){"use strict";a.r(t);var n=a(2),r=Object(n.a)({},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[a("p",[s._v("原理：Nginx会把访问日志写入access.log")]),s._v(" "),a("p",[s._v("当然 这不是 本文的重点")]),s._v(" "),a("p",[s._v("这种东西Google一下，一大堆")]),s._v(" "),a("p",[s._v("本文要实现的功能")]),s._v(" "),s._m(0),s._v(" "),s._m(1),s._v(" "),s._m(2),s._m(3),s._v(" "),a("p",[s._v("根据上述脚本，我们知道如何获取去重后的总Pv")]),s._v(" "),a("p",[s._v("要获得时间段内的Pv，只需要对access.log中的数据进行一次筛选")]),s._v(" "),s._m(4),a("p",[s._v("可以看到在原有的代码基础上增加了sed处理")]),s._v(" "),s._m(5),s._v(" "),s._m(6),s._m(7),s._v(" "),a("p",[s._v("先来看下我们想实现怎么样的效果")]),s._v(" "),a("p",[s._v("把RADEME.md文件的最后一行替换为新的")]),s._v(" "),s._m(8),a("p",[s._v("我们把 这一行文字 分成 五部分"),a("br"),s._v(" "),a("center",[s._v("历史访问量："),a("code",[s._v("$(total Pv)")]),s._v(" | 昨日访问量: "),a("code",[s._v("$(yesterday Pv)")])]),a("br"),s._v("\n主要是两个数据，需要利用两个脚本分别算出来")],1),s._v(" "),s._m(9),s._v(" "),a("p",[s._v("剩下的字符串也通过脚本写入文件中")]),s._v(" "),s._m(10),s._v(" "),a("p",[s._v("得到")]),s._v(" "),s._m(11),a("p",[s._v("这样的脚本能用，但需要每天改时间")]),s._v(" "),a("p",[s._v("于是，同理把时间改为变量,再在最后调用部署脚本")]),s._v(" "),s._m(12),s._m(13),s._v(" "),a("p",[s._v("Linux下crontab作为定时任务托管平台")]),s._v(" "),s._m(14),s._v(" "),a("p",[s._v("但是定时任务的环境与直接运行脚本不太一样")]),s._v(" "),a("p",[s._v("定时任务相当于在/目录下运行command")]),s._v(" "),a("p",[s._v("lz因为这个问题查了好久，最后发现build.sh 里因为一句话权限不够导致不能执行")]),s._v(" "),s._m(15),s._v(" "),a("p",[s._v("如果出现定时任务不生效的情况，可以使用打日志的方式")]),s._v(" "),s._m(16)])},[function(){var s=this.$createElement,t=this._self._c||s;return t("ol",[t("li",[this._v("获取总page view，注意去重，同一ip只记录一次")]),this._v(" "),t("li",[this._v("获取时间段中的page view")]),this._v(" "),t("li",[this._v("脚本化（时间变量化，写入文件自动化）")]),this._v(" "),t("li",[this._v("定时任务")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"总pv"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总pv","aria-hidden":"true"}},[this._v("#")]),this._v(" 总PV")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'{print "),a("span",{attrs:{class:"token variable"}},[s._v("$1")]),s._v("}'")]),s._v(" /usr/local/nginx/logs/access.log"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("uniq")]),s._v(" -c "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("pv")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# sort  - 按ip进行排序")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# uniq  - 去重")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# wc -l - 统计行数")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# awk   - 输出结果")]),s._v("\n")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"时间段pv"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#时间段pv","aria-hidden":"true"}},[this._v("#")]),this._v(" 时间段Pv")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'{split("),a("span",{attrs:{class:"token variable"}},[s._v("$4")]),s._v(',array,"[");if(array[2]>="25/Sep/2018:00:00:00" && array[2]<="25/Sep/2018:23:59:59"){print '),a("span",{attrs:{class:"token variable"}},[s._v("$1")]),s._v("}}'")]),s._v(" /usr/local/nginx/logs/access.log"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("uniq")]),s._v(" -c "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l\n")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"剔除status不为200的数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#剔除status不为200的数据","aria-hidden":"true"}},[this._v("#")]),this._v(" 剔除Status不为200的数据")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'{if("),a("span",{attrs:{class:"token variable"}},[s._v("$9")]),s._v("==200)print "),a("span",{attrs:{class:"token variable"}},[s._v("$0")]),s._v("}'")]),s._v(" /var/log/nginx/access.log\n")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"脚本化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#脚本化","aria-hidden":"true"}},[this._v("#")]),this._v(" 脚本化")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-jsx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[s._v("<")]),s._v("center")]),a("span",{attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{attrs:{class:"token plain-text"}},[s._v("历史访问量：2645 | 昨日访问量: 280")]),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[s._v("</")]),s._v("center")]),a("span",{attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("为了让数据落盘"),t("br"),this._v("\n只能通过 "),t("code",[this._v(">>")]),this._v(" 存到文件中，持久化")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("最后再用一条 "),t("code",[this._v("echo $(cat xxx)")]),t("br"),this._v("\n把文件中的字符串压成一行")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("loglocal"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx/logs/access.log\n"),a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v('"<center>累计访问量:"')]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'{if("),a("span",{attrs:{class:"token variable"}},[s._v("$9")]),s._v("==200)print "),a("span",{attrs:{class:"token variable"}},[s._v("$1")]),s._v("}'")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("$loglocal")]),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("uniq")]),s._v(" -c "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v('"| 昨日访问量:"')]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'{if("),a("span",{attrs:{class:"token variable"}},[s._v("$9")]),s._v("==200){split("),a("span",{attrs:{class:"token variable"}},[s._v("$4")]),s._v(',array,"[");if(array[2]>="08\\/Sep\\/2018:00:00:00" && array[2]<="08\\/Sep\\/2018:23:59:59"){print '),a("span",{attrs:{class:"token variable"}},[s._v("$1")]),s._v("}}}'")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("$loglocal")]),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("uniq")]),s._v(" -c "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v('"</center>"')]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{attrs:{class:"token string"}},[s._v("'"),a("span",{attrs:{class:"token variable"}},[s._v("$d")]),s._v("'")]),s._v(" docs/README.md\n"),a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[a("span",{attrs:{class:"token variable"}},[s._v("$(")]),a("span",{attrs:{class:"token function"}},[s._v("cat")]),s._v(" log/pv"),a("span",{attrs:{class:"token variable"}},[s._v(")")])]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" docs/README.md\n")])])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("loglocal"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx/logs/access.log\n"),a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v('"<center>累计访问量:"')]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'{if("),a("span",{attrs:{class:"token variable"}},[s._v("$9")]),s._v("==200)print "),a("span",{attrs:{class:"token variable"}},[s._v("$1")]),s._v("}'")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("$loglocal")]),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("uniq")]),s._v(" -c "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v('"| 昨日访问量:"')]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/pv\nyMonth"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token variable"}},[a("span",{attrs:{class:"token variable"}},[s._v("`")]),a("span",{attrs:{class:"token function"}},[s._v("date")]),s._v(" -d yesterday +%B"),a("span",{attrs:{class:"token variable"}},[s._v("`")])]),s._v("\ntoday"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token string"}},[s._v('"'),a("span",{attrs:{class:"token variable"}},[a("span",{attrs:{class:"token variable"}},[s._v("$(")]),a("span",{attrs:{class:"token function"}},[s._v("date")]),s._v(" -d yesterday +%d"),a("span",{attrs:{class:"token variable"}},[s._v(")")])]),s._v("/"),a("span",{attrs:{class:"token variable"}},[s._v("${yMonth:0:3}")]),s._v("/"),a("span",{attrs:{class:"token variable"}},[a("span",{attrs:{class:"token variable"}},[s._v("$(")]),a("span",{attrs:{class:"token function"}},[s._v("date")]),s._v(" -d yesterday +%Y"),a("span",{attrs:{class:"token variable"}},[s._v(")")])]),s._v('"')]),s._v("\nam"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token string"}},[s._v('"'),a("span",{attrs:{class:"token variable"}},[s._v("$today")]),s._v(':00:00:00"')]),s._v("\npm"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token string"}},[s._v('"'),a("span",{attrs:{class:"token variable"}},[s._v("$today")]),s._v(':23:59:59"')]),s._v("\n"),a("span",{attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'{if("),a("span",{attrs:{class:"token variable"}},[s._v("$9")]),s._v("==200){split("),a("span",{attrs:{class:"token variable"}},[s._v("$4")]),s._v(',array,"[");if(array[2]>=am && array[2]<=pm){print '),a("span",{attrs:{class:"token variable"}},[s._v("$1")]),s._v("}}}'")]),s._v(" am"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token string"}},[s._v('"'),a("span",{attrs:{class:"token variable"}},[s._v("$am")]),s._v('"')]),s._v(" pm"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token string"}},[s._v('"'),a("span",{attrs:{class:"token variable"}},[s._v("$pm")]),s._v('"')]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("$loglocal")]),a("span",{attrs:{class:"token operator"}},[s._v("|")]),a("span",{attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("uniq")]),s._v(" -c "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v('"</center>"')]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/pv\n"),a("span",{attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{attrs:{class:"token string"}},[s._v("'"),a("span",{attrs:{class:"token variable"}},[s._v("$d")]),s._v("'")]),s._v(" docs/README.md\n"),a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[a("span",{attrs:{class:"token variable"}},[s._v("$(")]),a("span",{attrs:{class:"token function"}},[s._v("cat")]),s._v(" log/pv"),a("span",{attrs:{class:"token variable"}},[s._v(")")])]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" docs/README.md\n")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#定时任务","aria-hidden":"true"}},[this._v("#")]),this._v(" 定时任务")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("通过"),t("code",[this._v("crontab -e")]),this._v("定制")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("最后加了一个"),t("code",[this._v("sudo")]),this._v("就解决了 坑爹")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("*/10 * * * * "),a("span",{attrs:{class:"token function"}},[s._v("cd")]),s._v(" /usr/local/www/wyydsb/blog "),a("span",{attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("bash")]),s._v(" pv.sh "),a("span",{attrs:{class:"token operator"}},[s._v(">>")]),s._v(" log/crontab.log 2"),a("span",{attrs:{class:"token operator"}},[s._v(">")]),a("span",{attrs:{class:"token operator"}},[s._v("&")]),s._v("1\n"),a("span",{attrs:{class:"token comment"}},[s._v("# 2>&1 打日志")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# 五个* 分别代表 分 时 天 月 年")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# * 代表任意")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# */10 时间除以10变化时更新一次 即每个10执行一次")]),s._v("\n")])])])}],!1,null,null,null);r.options.__file="pv.md";t.default=r.exports}}]);