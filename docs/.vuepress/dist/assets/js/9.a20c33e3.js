(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{442:function(v,_,i){"use strict";i.r(_);var t=i(2),a=Object(t.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var v=this,_=v.$createElement,i=v._self._c||_;return i("div",{staticClass:"content"},[i("h2",{attrs:{id:"事故说明"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#事故说明","aria-hidden":"true"}},[v._v("#")]),v._v(" 事故说明")]),v._v(" "),i("p",[i("em",[v._v("事故")]),v._v("：Ali Yun ECS Linux内核导致服务不可用"),i("br"),v._v(" "),i("em",[v._v("Owner")]),v._v("：滚键盘"),i("br"),v._v(" "),i("em",[v._v("业务")]),v._v("：All"),i("br"),v._v(" "),i("em",[v._v("开始时间")]),v._v("：2018-09-24 00:02"),i("br"),v._v(" "),i("em",[v._v("结束时间")]),v._v("：2018-09-25 14:39"),i("br"),v._v(" "),i("em",[v._v("影响")]),v._v("：总计39h，GMV影响为400左右"),i("br"),v._v(" "),i("em",[v._v("事故定级")]),v._v("：一级事故")]),v._v(" "),i("h2",{attrs:{id:"事故分析"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#事故分析","aria-hidden":"true"}},[v._v("#")]),v._v(" 事故分析")]),v._v(" "),i("h3",{attrs:{id:"事故经过"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#事故经过","aria-hidden":"true"}},[v._v("#")]),v._v(" 事故经过")]),v._v(" "),i("p",[i("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2018/png/104214/1538797773631-65aba1f2-33e9-4dad-898d-c6157d38cd10.png",alt:"图片.png | left | 400x200"}})]),v._v(" "),i("ul",[i("li",[v._v("2018-09-24 00:02 Ali Yun 上ECS 跑完最后一次脚本任务，CPU从打满降落至11%左右，与平常回落至0%不一致，且出现ssh不能连接的现象")]),v._v(" "),i("li",[v._v("2018-09-24 00:13 在尝试解决问题未果的前提下，对实例进行正常重启操作")]),v._v(" "),i("li",[v._v("2018-09-24 00:17 ECS经过5min左右停止，重新启动后CPU彪至90%+，进入远程连接之后，显示Linux载入Error")]),v._v(" "),i("li",[v._v("2018-09-24 00:21 创建工单求助客服")]),v._v(" "),i("li",[v._v("2018-09-24 00:25 反馈CPU跑满，建议利用远程连接查看日志")]),v._v(" "),i("li",[v._v("2018-09-24 00:40 反馈日志截图")]),v._v(" "),i("li",[v._v("2018-09-24 00:43 反馈内核问题，建议先制作快照")]),v._v(" "),i("li",[v._v("2018-09-24 01:11 快照制作完毕")]),v._v(" "),i("li",[v._v("2018-09-24 01:19 授权Ali Yun操作实例")]),v._v(" "),i("li",[v._v("2018-09-24 01:41 修复失败建议初始化")]),v._v(" "),i("li",[v._v("2018-09-24 11:41 初始化之后ssh再次失效")]),v._v(" "),i("li",[v._v("2018-09-24 18:01 回滚快照之后，出现CPU跑满，Linux卡在初始化状态")]),v._v(" "),i("li",[v._v("2018-09-25 14:39 恢复服务")]),v._v(" "),i("li",[v._v("2018-09-26 15:30 恢复数据")])]),v._v(" "),i("h3",{attrs:{id:"事故反思"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#事故反思","aria-hidden":"true"}},[v._v("#")]),v._v(" 事故反思")]),v._v(" "),i("ol",[i("li",[v._v("无机器监控配置，实例失常状态不可知；")]),v._v(" "),i("li",[v._v("无数据备份机制，重要日志数据极易丢失；")]),v._v(" "),i("li",[v._v("无快照备份机制，事故发生之后恢复服务困难；")]),v._v(" "),i("li",[v._v("机器配置不可理，T5突发性能实例CPU仅可用10%，CPU性能偏弱。")]),v._v(" "),i("li",[v._v("暴露了服务流程管理混乱，极易不可用，尤其是目前单实例阶段；")]),v._v(" "),i("li",[v._v("实际上事后反思是因为内存打满导致的CPU彪高，再因为重启导致的内核崩溃；")])]),v._v(" "),i("ul",[i("li",[v._v("正确的处理方法应该是远程连接->top->M/P->k kill杀死彪高进程")]),v._v(" "),i("li",[v._v("之后10.2晚又出现相同情况，在合理操作下规避了内核崩溃的风险")])]),v._v(" "),i("h3",{attrs:{id:"恢复经验及改进："}},[i("a",{staticClass:"header-anchor",attrs:{href:"#恢复经验及改进：","aria-hidden":"true"}},[v._v("#")]),v._v(" 恢复经验及改进：")]),v._v(" "),i("ol",[i("li",[v._v("Linux内核尽量不升级，保持稳定可用性，谨小慎微；")]),v._v(" "),i("li",[v._v("监控报警体系需完善，安装类似『Ptrace Agent』的监控组件；")]),v._v(" "),i("li",[v._v("理清T5突发实例与正常实例的区别与联系，云厂商产品设计思路；")]),v._v(" "),i("li",[v._v("理清源码安装过程；")]),v._v(" "),i("li",[v._v("重新梳理Nginx调优步骤, 目前支持TLS1.3, h2, HSTS等;")]),v._v(" "),i("li",[v._v("了解Ali Yun从数据盘导数据流程;")]),v._v(" "),i("li",[v._v("优化pv脚本;")]),v._v(" "),i("li",[v._v("增加日志备份定时任务;")]),v._v(" "),i("li",[v._v("shell->hadoop, 利用MapReduce减小内存占用，提高效率；")])]),v._v(" "),i("h4",{attrs:{id:"导数据流程"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#导数据流程","aria-hidden":"true"}},[v._v("#")]),v._v(" 导数据流程")]),v._v(" "),i("ol",[i("li",[v._v("制作快照")]),v._v(" "),i("li",[v._v("利用快照制作云盘")]),v._v(" "),i("li",[v._v("挂载云盘（如果你能挂载上实例，当然是最好的，否则可以按量购买一台高配ECS挂载于此）")]),v._v(" "),i("li",[i("code",[v._v("mount /dev/vdb1 /mnt")]),v._v(" 挂载数据盘，切记在之前不能对数据盘分区，不能初始化数据盘，否则数据全没了")]),v._v(" "),i("li",[v._v("利用"),i("code",[v._v("fdisk -l")]),v._v(","),i("code",[v._v("df -h")]),v._v("查看磁盘及挂载情况")]),v._v(" "),i("li",[v._v("若挂载成功，此时"),i("code",[v._v("/mnt")]),v._v("就是你之前的"),i("code",[v._v("/")]),v._v("路径")])]),v._v(" "),i("h4",{attrs:{id:"源码安装"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#源码安装","aria-hidden":"true"}},[v._v("#")]),v._v(" 源码安装")]),v._v(" "),i("ol",[i("li",[v._v("wget tar.gz 文件")]),v._v(" "),i("li",[v._v("tar -xzvf 压缩包")]),v._v(" "),i("li",[v._v("./configure or ./bootstrap 进行编译，此时带的参数是安装模块，安装路径等")]),v._v(" "),i("li",[v._v("make 即build, 可加-j8")]),v._v(" "),i("li",[v._v("make install")]),v._v(" "),i("li",[v._v("cmake的安装是我见过最费内存，时间最长的，可能会提示虚拟内存不够的情况，"),i("code",[v._v("dd if=/dev/zero of=/swap bs=32M count=16")]),v._v("命令扩容")]),v._v(" "),i("li",[v._v("有些编译可能会报错，可能是有些包未安装导致的")])])])}],!1,null,null,null);a.options.__file="accident.md";_.default=a.exports}}]);