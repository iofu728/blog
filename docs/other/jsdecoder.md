---
title: ç©¶ç«Ÿæ˜¯é“å¾·çš„æ²¦ä¸§ï¼Œè¿˜æ˜¯ç°å®çš„éª¨æ„Ÿï¼Œè®©æºç¨‹åçˆ¬å·¥ç¨‹å¸ˆåœ¨ä»£ç é‡Œå†™ä¸‹è¿™å¥è¯-ã€çˆ¬è™«è¿›é˜¶ç¬¬äºŒå¼¹ã€
date: 2019-04-21 18:13:11
tags: [Spider]
description: çˆ¬è™«è¿›é˜¶æŠ€å·§
---

æœ¬æ–‡ä»…ç”¨ä½œ**å­¦ä¹ äº¤æµ**ï¼Œ**ä¸å¾—ç”¨äºä»»ä½•å•†ä¸šç”¨é€”**ï¼›

---

> 4 æœˆçš„åŒ—äº¬ï¼Œè¿™å¤©æ°”åƒæ˜¯ 80 å²çš„ä½¬è±è± ğŸ‘µï¼Œæ‚å¾—æ…Œã€‚
> ä¸€ä¸ªæ…µæ‡’çš„è§’è½ï¼Œé˜µé˜µå™¼å•ªå£°ï¼Œå¤¹æ‚ç€å¹æ°”ï¼Œä¸€åèº«ç€æ ¼å­è¡¬è¡«ï¼Œå¤´å‘ç¨€ç–çš„å°å“¥ä¸“æ³¨çš„çœ‹ç€å±å¹•ã€‚
> ä¼´éšç€åšå®šçš„çœ¼ç¥çš„ä»–ï¼Œå¿«é€Ÿçš„æ•²ä¸‹äº†ä¸€è¡Œå‘½ä»¤ã€‚å˜´è¾¹å’•å“ç€ï¼Œâ€˜è¿™æ¬¡ä¸€å®šæˆäº†â€™ã€‚
> è€Œå±å¹•çš„é‚£å¤´ï¼Œç»ˆäºæœ‰äº†äº›è®¸åæ˜ ï¼Œä¸€ä¸ªä¸ªå­—ç¬¦è¹¦äº†å‡ºæ¥ï¼Œåƒæäº†`[é»‘é•œï¼šæ½˜è¾¾æ–¯å¥ˆåŸº]`è¢«æ“æ§çš„èµ¶è„šã€‚
> æœ¬æ¥é¢éœ²æœŸå¾…çš„å°å“¥ï¼Œå´åªå‰©ä¸‹æ»¡è„¸çš„è‹¦ç¬‘ ğŸ˜‚ã€‚
> åªè§å±å¹•ä¸Šæ¬£ç„¶å‡ºç°è¿™ä¹ˆä¸€å¥è¯
> ![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555907913480-5d5ca694-f788-424c-9230-2889043cfeac.png)

ä¸Šæ¬¡å‘å®Œ[ä½ å·²ç»æ˜¯ä¸€ä¸ªæˆç†Ÿçš„çˆ¬è™«äº†ï¼Œåº”è¯¥å­¦ä¼šè‡ªå·±å»å¯¹æŠ—åçˆ¬ç å†œäº† ğŸ™Š-ã€çˆ¬è™«è¿›é˜¶æŒ‡å—ã€](https://zhuanlan.zhihu.com/p/61575267)å°±ä¸æ–­æœ‰å°ä¼™ä¼´å‘æˆ‘æˆ‘è¯·æ•™å¦‚ä½•è§£å†³ä¸€äº› js é€†å‘å·¥ç¨‹çš„é—®é¢˜

å…¶å®è¿™ä¸ªé—®é¢˜è¯´å°äº†æ¶‰åŠ jsã€py åŸºç¡€è¯­æ³•ï¼Œè¯´å¤§äº†æ¶‰åŠç½‘ç»œæ”»é˜²ï¼Œæ¶‰åŠå¯¹æ–¹å…¬å¸æ¶æ„ï¼Œç”šè‡³æ¶‰å¯†ã€‚

è€Œä¸”åšè¿™ç§é€†å‘å·¥ç¨‹è¿˜ç‰¹åˆ«è´¹æ—¶é—´ï¼Œ(å…¶å®åçˆ¬å·¥ç¨‹å¸ˆåšåŠ å¯†æ–¹æ¡ˆä¹Ÿç‰¹åˆ«ç´¯ï¼Œ æ‰€ä»¥ä¸€èˆ¬åšè¿™ç§`æ··æ·†åŠ å¯†`çš„éƒ½æ˜¯è¯¥å…¬å¸çš„æ ¸å¿ƒä¸šåŠ¡)ï¼Œæ‰€ä»¥è¿™æ–¹ä¾¿çš„èµ„æ–™å…¶å®ç‰¹åˆ«å°‘ã€‚

è¿˜æ˜¯å†æƒ³æé†’ä¸‹å¤§å®¶ï¼Œçˆ¬è™«æ˜¯ä¸€ä¸ªè·å–ä¿¡æ¯çš„å¥½å·¥å…·ï¼Œä½†è¿˜è¯·ç›¸äº’ä½“è°…ï¼Œæœ¬æ–‡ä¹Ÿä»…ç”¨ä½œå­¦ä¹ ä½¿ç”¨ã€‚

æœ¬æ–‡åˆ†æä¸¤ä¸ªæ¡ˆä¾‹ï¼Œä¸€ä¸ªæ˜¯å»å¹´è¢«çˆ¬æ€•äº†çš„`é©¬èœ‚çª`ï¼Œä¸€ä¸ªæ˜¯`æºç¨‹`, åƒè¿™ç§å…¬å¸ä½“é‡å¾ˆå¤§ï¼Œä¸šåŠ¡ç¹å¤šï¼Œä¹Ÿä¸å¯èƒ½å…¨éƒ¨åˆ†æï¼Œå…·ä½“æ¥è¯´:

- [é©¬èœ‚çªçš„æ™¯ç‚¹ä¿¡æ¯, ï¼ˆå¯èƒ½æ˜¯è¢«çˆ¬æ€•äº†å§ ğŸ¤ï¼‰](http://www.mafengwo.cn/jd/10186/gonglve.html)
- [æºç¨‹çš„é…’åº—è¯¦æƒ…é¡µ, æ¶‰åŠåŠ¨æ€é…’åº—æˆ¿æºåº“å­˜ï¼Œæˆ¿å‹ï¼Œä»·æ ¼](https://hotels.ctrip.com/hotel/4889292.html)

**ä¹±å…¥æ€»ç»“:**

- **æºç¨‹ 996**
- é©¬èœ‚çªçœ‹ä¸å‡ºæ¥ æ˜¯ä¸æ˜¯ 996

æ‰“ä¸ªå°å¹¿å‘Š, æ±‚ star[è‡ªå¸¦é«˜å¯ç”¨ Proxy åº“çš„ spider ä»£ç ](https://github.com/iofu728/spider) hhh

## é©¬èœ‚çª

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555894492064-b531da3e-c648-42b3-8bb9-56f3fc3eb069.png)

æˆ‘ä»¬è¦çˆ¬çš„æ˜¯æ‰€æœ‰æ™¯ç‚¹ä¿¡æ¯ï¼Œè¿™ä¸ªä¿¡æ¯æ˜¯è¯·æ±‚`http://www.mafengwo.cn/ajax/router.php`è·å–çš„

å…¶ä¸­éœ€è¦ä¸€å¨å‚æ•°ï¼Œé™¤äº†ä¸€çœ¼èƒ½çœ‹å‡ºè¯­ä¹‰çš„å‚æ•°ä¹‹å¤–ï¼Œä¹Ÿå°±`_sn`, `sAct`(å¯æƒœå®ƒä¸å˜)å¯èƒ½æ˜¯è¢«åŠ å¯†è¿‡çš„ã€‚

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555894491808-06716ae6-d12b-47d4-a843-ce744f3fbd4d.png)

google äº†ä¸€ä¸‹æ²¡å‘ç°æœ‰æä¾›è§£å†³æ–¹æ¡ˆçš„~~(å¿«é€Ÿè§£å†³é—®é¢˜æ‰æ˜¯ç‹é“)~~ï¼Œå¤§æ¦‚æ¨æµ‹äº†ä¸€ä¸‹é©¬èœ‚çªåœ¨å»å¹´å¹´åº•åšäº†è¿™æ¬¡åŠ å¯†æ–¹æ¡ˆã€‚

ç¬¬ä¸€ååº”ï¼Œä¸æ˜¯å…ˆåšé€†å‘ï¼Œè€Œæ˜¯çŒœæµ‹å¯èƒ½æ˜¯é€šè¿‡å‰ç½®è¯·æ±‚ä»åç«¯æ‹¿åˆ°çš„ï¼Œç„¶åç¿»äº†ä¸€ä¸‹å‘ç°å¹¶æ²¡æœ‰ï¼Œå¯¹æ¯”äº†ä¸€ä¸‹å‰åå‡ ä¸ªè¯·æ±‚ï¼Œå‘ç°è¿™ä¸ªå‚æ•°å‡ºç°æ¬¡æ•°è¿˜æŒºå¤šçš„ï¼Œ**è€Œä¸”å€¼è¿˜ä¸ä¸€æ ·**ï¼Œè¡Œäº† js åŠ å¯†çŸ³é”¤äº†

ç„¶åå»ç­›å“ªäº› js å¯¹è¿™ä¸ªå‚æ•°çš„ç”Ÿæˆæœ‰æ‰€å½±å“ï¼ˆç”¨ chrome çš„å¼€å‘è€…å·¥å…·æš´åŠ› blockï¼‰

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555894491885-4aa9c6d1-df6a-4d44-a147-7ae8442869b7.png)

é¥¿ ä»–ä»¬è¿™ js æœ‰ç‚¹å°‘ï¼Œé—­ç€çœ¼ç› éƒ½èƒ½çŒœå‡ºæ¥æ˜¯å“ªä¸ªï¼ŒjQuery ä¸€èˆ¬ä¼šæ”¾è‡ªå·±æ„é€  cookie æ„é€  Header å¤´çš„é€»è¾‘ï¼ˆå½“ç„¶è¿™é‡Œä¹Ÿæœ‰å¯èƒ½åŒæ—¶ä½¿ç”¨ Cookie & `_sn`ä¸€èµ·åšæ•ˆéªŒï¼‰

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åšä¸€ä¸ªå®éªŒï¼Œæ¥çœ‹ä¸€ä¸‹ Header é‡Œé¢çš„å†…å®¹æœ‰æ²¡æœ‰ä½œç”¨åœ¨ encoder å’Œ decoder ä¸­ã€‚

æ‰“å¼€ chrome çš„æ— ç—•æ¨¡å¼(æœ‰äº›æ—¶å€™éœ€è¦ clear ä¸€ä¸‹ History, è¿™è·Ÿ ServiceWork æœºåˆ¶æœ‰å…³ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥ä¸‹ç›¸å…³èµ„æ–™), å…ˆæ‰“å¼€å¼€å‘è€…æ¨¡å¼ï¼Œç„¶åé”®å…¥æˆ‘ä»¬çˆ¬å–çš„ URLã€‚

ï¼ˆç°åœ¨æˆ‘ä»¬æ¨¡æ‹Ÿçš„æ˜¯é¦–æ¬¡è¿›å…¥è¯¥ç½‘ç«™çš„ç”¨æˆ·ï¼Œé€šå¸¸ä¸ºäº†åšåˆ°é¦–æ¬¡åŠ è½½ç½‘é¡µåœ¨å‡ ç™¾ ms å†…ï¼Œéƒ½ä¼šå¯¹ä¸€äº›ä¸å¿…è¦çš„åŠŸèƒ½åš delay åŠ è½½æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™çš„æ¡ä»¶èƒ½è·å¾—åˆ°ä¿¡æ¯ï¼Œåˆ™ä¹‹åä¹Ÿèƒ½ï¼‰-è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå°æŠ€å·§å§ ğŸ¤–

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555898775208-4ac8717d-5889-4d36-9272-62c417368df1.png)

ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œæ²¡æœ‰ Cookie(è¿™ä¹Ÿå¯ä»¥ç†è§£ï¼ŒJQuery.js å’Œæ··æ·†æ‰€éœ€è¦çš„`/js/hotel/sign/index.js`ä¸¤ä¸ªæ–‡ä»¶æ˜¯å¼‚æ­¥è·å–çš„ï¼Œä¸ºäº†ä¿è¯ç”¨æˆ·çš„ç”¨æˆ·ä½“éªŒï¼Œå‰ç«¯åœ¨é¦–æ¬¡åŠ è½½åšäº†å¦¥åã€‚

ç„¶åæˆ‘ä»¬å·¥ä½œçš„é‡ç‚¹ï¼Œå°±æ˜¯ç ”ç©¶`http://js.mafengwo.net/js/hotel/sign/index.js?1552035728`è¿™ä¸ª js åšäº†å“ªäº›æ··æ·†

é¦–å…ˆï¼Œä¸€çœ‹è¿™ä¸ªå®‰å…¨åšçš„å°±ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œè¿™ä¸ª js æ˜¯é€šè¿‡é™æ€çš„ url æ¥è·å–çš„ï¼Œè·å–çš„è¿‡ç¨‹æ²¡æœ‰ä»»ä½•åŠ å¯†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘è§£å¯†å‡ºæ¥ä¸€æ¬¡ï¼Œåªè¦ä½ ä¸å‘ç‰ˆï¼Œæˆ‘åŸºæœ¬ä¸Šéƒ½èƒ½ç”¨(æ‰€ä»¥å¤§å®¶çœ‹çœ‹å°±è¡Œäº†ï¼Œåˆ«ç”¨åšå•†ä¸šç”¨é€”)

(ç„¶åï¼Œä»æ—¶é—´æˆ³ä¸Šçœ‹ï¼Œè¿™ä¸ªç‰ˆæœ¬æ˜¯`2019-03-08 17:02:08`å‘çš„ï¼Œæ‰€ä»¥èµ·ç è¿™ä¸€ä¸ªå¤šæœˆä»–ä»¬æ²¡æœ‰åšä»€ä¹ˆæ”¹åŠ¨ï¼Œ3 æœˆ 8 æ—¥æ˜ŸæœŸäº”ï¼Œhhh çœ‹ä¸å‡ºæ¥æ˜¯ä¸æ˜¯ 996

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555897357899-787c7237-bc34-4279-a49e-f0fcd064e2e9.png)

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»£ç ï¼Œé¦–å…ˆï¼Œè¿™ç§æ··æ·†ä¹Ÿåšçš„æ¯”è¾ƒå¥—è·¯ï¼Œå°±æ˜¯æœ€å¤–å±‚å †ä¸€å±‚ Unicode æ¥è®©ä½ ä¸èƒ½ç›´æ¥åœ¨ Preview ä¸­ç›´æ¥çœ‹å‡ºè¯­ä¹‰ä¿¡æ¯ï¼Œç„¶åä¸¢ä¸€ä¸ªæ•°ç»„æ¥å­˜ä½¿ç”¨çš„å­—ç¬¦å˜é‡

æ‰€ä»¥æˆ‘ä»¬ä¸€å¼€å§‹åšçš„äº‹æƒ…æ˜¯ï¼Œåš js ä»£ç è§£æ··æ·†ï¼Œèµ·ç å…ˆå˜æˆèƒ½çœ‹çš„ä»£ç ï¼ˆPS: çœ‹ Vscode ä¸­å³è¾¹ ğŸ‘‰ é¢„è§ˆä¸­ï¼Œé‚£ä¸€å¤§å¨å¾ˆè§„å¾‹çš„ä»£ç å—ï¼Œè¿™ä¸€å®šæ˜¯åšçš„æ˜¯ç±»ä¼¼ DES çš„å¤šå±‚åŠ å¯†è®¡ç®—

- è§£ Unicode `\\x75` -> `\x75` -> `codecs.unicode_escape_decode(origin_js)[0]`
- ä»ç¬¬äº”è¡Œçš„æ•°ç»„`__Ox2133f`ä¸­ï¼Œæ›¿æ¢å¸¸é‡å­—ç¬¦
- ç„¶åè¿™ç§æ— æ„ä¹‰çš„å˜é‡åç§°çœ‹çš„éš¾å—ï¼Œè€Œä¸”å¤ªé•¿ï¼Œå°±åšä¸€ä¸ªæ›¿æ¢
- ç„¶åç”¨ Vscodeï¼Œ`Toggle Format`æ’ä»¶åšä¸€ä¸‹è‡ªåŠ¨æ ¼å¼åŒ–

```python
def decode_js_test():
    ''' decode js for test '''
    with open(decoder_js_path, 'r') as f:
        decoder_js = [codecs.unicode_escape_decode(ii.strip())[0] for ii in f.readlines()]
    __Ox2133f = [ii.strip() for ii in decoder_js[4][17:-2].replace('\"', '\'').split(',')]
    decoder_str = '|||'.join(decoder_js)
    params = re.findall(r'(\_0x\w{6,8}?)=|,|\)', decoder_str)
    params = sorted(list(set([ii for ii in params if len(ii) > 6])), key=lambda ii: len(ii), reverse=True)
    for ii, jj in enumerate(__Ox2133f):
        decoder_str = decoder_str.replace('__Ox2133f[{}]'.format(ii), jj)
    for ii, jj in enumerate(params):
        decoder_str = decoder_str.replace(jj, 'a{}'.format(ii))
    decoder_js = decoder_str.split('|||')
    with open(origin_js_path, 'w') as f:
        f.write('\n'.join(decoder_js))
    return decoder_js
```

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555897357854-6681edcc-9753-4baf-8f4d-315e918867ad.png)

ç»è¿‡åˆæ­¥çš„è§£è€¦ä¹‹åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸Šé¢çš„ä»£ç ã€‚å¯ä»¥çœ‹åˆ°åœ¨ç¬¬ 389 è¡Œå‡ºç°äº†æˆ‘ä»¬éœ€è¦çš„ `_sn` å˜é‡ ğŸ˜™

```js
a40["ajaxPrefilter"](function(a410, a411) {
  var a23 = a40["extend"](true, {}, a411["data"] || {}); // æ‹¿data
  if (a23["_sn"]) {
    delete a23["_sn"]; // åˆ å»å·²æœ‰çš„`_sn`
  }
  a23["_ts"] = new Date()["getTime"](); // `_ts` = 13ä½æ—¶é—´æˆ³
  var a13 = a425(a40["extend"](true, {}, a23)); // åŠ å¯†äº†
  if ("data" in a410) {
    a410["data"] += "&_ts=" + a23["_ts"] + "&_sn=" + a13; // æ‹¼æ¥å­—ç¬¦ä¸²
  } else {
    a410["data"] = "_ts=" + a23["_ts"] + "&_sn=" + a13;
  }
});
```

ä¸Šé¢è¿™å¨ä»£ç å®é™…ä¸Šå°±æ˜¯å®ç°`_sn`çš„å…¥å£å‡½æ•°ï¼Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æŠŠæ‹¿åˆ°çš„æ‹¿åˆ°çš„ data åŠ ä¸Šå½“å‰æ—¶é—´æˆ³ï¼Œä¸¢ç»™ a425 è¿™ä¸ªå‡½æ•°

`a425`å°±æ˜¯ä¸Šé¢é‚£å¼ å›¾ç¬¬ 348 è¡Œå®šä¹‰çš„ï¼Œa425 ä¹Ÿå°± 40 å¤šè¡Œä»£ç ï¼Œé€»è¾‘ä¹Ÿå¾ˆç®€å•

ä»–æ˜¯è°ƒç”¨äº†`a36`è¿™ä¸ªå‡½æ•°çš„`hash`æ–¹æ³•ï¼Œä¼ è¿›å»äº†(ä¸€ä¸ªæŠŠ Object åšäº† JSON åºåˆ—åŒ–çš„å­—ç¬¦ä¸²ï¼Œåœ¨åŠ ä¸Šäº†ä¸€ä¸ªå­—ç¬¦å¸¸é‡)ï¼Œæœ€åå¯¹ç»“æœæˆªå–äº† 2ï¼Œ12 ä½

ç„¶å`a18`å°±æ˜¯ä¸Šé¢é‚£è¡Œè°ƒç”¨äº†ä¸€ä¸‹`a427`çš„è¿”å›å€¼ï¼Œå¤§æ¦‚æ‰«ä¸€çœ¼ï¼Œ`a427`åšäº†ä¸€ä»¶æŒ‰ dict çš„`keys`æ’åºçš„å·¥ä½œ(å› ä¸ºåé¢è¦åš JSON åºåˆ—åŒ–ï¼Œé¡ºåºå¾ˆé‡è¦)

ç„¶å`hash`å‡½æ•°æ˜¯åœ¨ç¬¬ 283 è¡Œå®šä¹‰çš„

```js
a36["hash"] = function(a11, a36a) {
  if (/[Â€-ï¿¿]/["test"](a11)) {
    a11 = unescape(encodeURIComponent(a11));
  }
  var a26 = a38(a11); // å®é™…ä¸Ša36aå°±æ˜¯å‘Šè¯‰ä½ åšå‡ å±‚åŠ å¯†
  return !!a36a ? a26 : a9(a26);
};
```

æˆ‘æƒ³ä½ å¬åˆ°è¿™é‡Œå·²ç»æ‡µé€¼äº†ï¼Œç„¶åæˆ‘å‘Šè¯‰ä½ ï¼Œå…¶å®è¿™ä¸ªçš„é€†å‘å·²ç»åšå®Œäº†ï¼Œåªè¦æ‰¾åˆ°å…¥å£å‡½æ•°ï¼Œï¼ˆåªè¦æ¥ä¸‹æ¥çš„æ‰€æœ‰å‡½æ•°éƒ½åœ¨æœ¬æ–‡ä»¶èŒƒå›´å†…ï¼‰é—®é¢˜ä¸€åˆ‡éƒ½è§£å†³äº†

çˆ¬è™« æœ¬è´¨ä¸Šæ¥è®² å°±æ˜¯åšä¸€ä¸ªæ¨¡æ‹Ÿæµè§ˆå™¨çš„å·¥ä½œã€‚ä»æœ€å¼€å§‹çš„æ¨¡æ‹Ÿæµè§ˆå™¨å‘ HTTP è¯·æ±‚ï¼Œå‘ WebSocket è¯·æ±‚ï¼Œåˆ°åé¢çš„æ¨¡æ‹Ÿæµè§ˆå™¨ç¼–è¯‘ jsï¼Œå…¶å®åšçš„éƒ½æ˜¯ä¸€ä»¶äº‹æƒ…ã€‚

åœ¨è¿™é‡Œåšé€†å‘ï¼Œä¹Ÿæ˜¯æ¨¡æ‹Ÿæµè§ˆå™¨åš js çš„ç¼–è¯‘ï¼Œé‚£ä¸ºä»€ä¹ˆä¸è®© node æˆ–è€… chrome v8 å¸®æˆ‘ä»¬åšè¿™äº›äº‹æƒ…å‘¢ã€‚

å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºå¾ˆå¤š js ç¼–è¯‘éœ€è¦ä¸€ä¸ª DOMï¼Œå½“ç„¶æˆ‘ä»¬æœ‰äº† jsdom ä¹‹åï¼Œè¿™å°±ä¸æ˜¯é—®é¢˜äº†

æ‰€ä»¥æˆ‘ä»¬æŒ‰ç€åˆšæ‰çš„æ€è·¯è§£ææ„é€  dataï¼Œæ·»åŠ `_ts`æ—¶é—´æˆ³ï¼Œåšæ’åºï¼ŒåŠ ç›ï¼Œç„¶åä¸¢ç»™ä¸Šé¢çš„ a36 å‡½æ•°æ˜¯ä¸æ˜¯å°±å¯ä»¥äº†

```js
const jsdom = require("jsdom");
const { JSDOM } = jsdom;

function analysis_js(html, salt, prepare_map) {
  const dom = new JSDOM(html);
  window = dom.window;
  document = window.document;
  window.decodeURIComponent = decodeURIComponent;

  const script_element = document.querySelector("script");
  console.log(script_element);
  const script = script_element.innerHTML;
  eval(script);
  return window["SparkMD5"]
    ["hash"](JSON["stringify"](prepare_map) + salt)
    ["slice"](2, 12);
}
```

åœ¨å®é™…æ“ä½œè¿‡ç¨‹ä¸­éœ€è¦æŠŠæœ€åä¸€æ®µå…¥å£å‡½æ•°åˆ äº†ï¼Œå› ä¸ºä»–ä¼šæ‰ JQuery ä¸­å®šä¹‰çš„ä¸€ä¸ªå˜é‡, å½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨å‰é¢ç”³æ˜ä¸€ä¸‹è¿™ä¸ªå˜é‡ã€‚

[å…·ä½“ä»£ç å‚è§](https://github.com/iofu728/spider/blob/master/mafengwo/mafengwo.py)

æ‹¿åˆ°å¤§æ¦‚ 95w ä¸ªæ™¯ç‚¹ä¿¡æ¯ï¼Œè‡³äºä¸ºä»€ä¹ˆèŠ±äº† 6 ä¸ªå°æ—¶ï¼Œå› ä¸ºæ¯ä¸ªé¡µé¢éƒ½éœ€è¦å»è°ƒ node å»ç¼–è¯‘ï¼Œè¿™ä¸ªå¹¶å‘æ•°å°±ä¸èƒ½å¼€å¤ªå¤šï¼Œè¯•äº†ä¸€ä¸‹è¶…è¿‡ 300 æˆ‘çš„ MBP å°±ä¸å¬è¯äº†ï¼Œæœ€åå¼€äº† 150 ä¸ªï¼ˆè¿™ä¸ªåé¢æœ‰ç©ºå¯ä»¥è°ƒä¼˜ä¸€ä¸‹

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555900934786-18e14b43-c6c7-466f-93e3-2e71bc747272.png)

çœ‹ç€é»„è‰²çš„`_sn`å¼¹å‡ºæ¥çš„æ—¶å€™ï¼Œæ»¡è„¸çš„å–œæ‚¦ ğŸŒš

## æºç¨‹é…’åº—è¯¦æƒ…é¡µ

å’Œæºç¨‹æ¯”èµ·æ¥ï¼Œå‰é¢çš„é©¬èœ‚çªå°±æ˜¯ä¸ªå¼Ÿå¼Ÿï¼ˆå¤ªçœŸå®äº†ï¼Œå½“ç„¶è¿™éƒ¨åˆ†æ¯”è¾ƒæ¶‰åŠæºç¨‹ä»–ä»¬æ ¸å¿ƒä¸šåŠ¡äº†ï¼Œåšçš„å¥½ä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555902084552-056e0124-3b2d-4792-bbdd-de9e5281d604.png)

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯çˆ¬å–ä¸Šé¢ç½‘é¡µä¸­å„ç§æˆ¿å‹ï¼ŒåŠå…¶å®æ—¶ä»·æ ¼(è¯è¯´æˆ‘åœ¨åšè¿™ä¸ªé¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œè§è¯äº†è¿™ä¸ªé…’åº—ä»æœ€ä½çš„ 2k ä¸€æ™šæ¶¨åˆ°ç°åœ¨æœ€ä½ 2.5k ä¸€æ™šï¼Œæœ‰é’±çœŸå¥½ ğŸ™Š

ç›´æ¥åˆ‡å…¥æ­£é¢˜ï¼Œè¦çš„ä¿¡æ¯æ˜¯é€šè¿‡`https://hotels.ctrip.com/Domestic/tool/AjaxHote1RoomListForDetai1.aspx?psid=&MasterHotelID=4889292&hotel=4889292&EDM=F&roomId=&IncludeRoom=&city=2&showspothotel=T&supplier=&IsDecoupleSpotHotelAndGroup=F&contrast=0&brand=776&startDate=2019-04-22&depDate=2019-04-23&IsFlash=F&RequestTravelMoney=F&hsids=&IsJustConfirm=&contyped=0&priceInfo=-1&equip=&filter=&productcode=&couponList=&abForHuaZhu=&defaultLoad=T&esfiltertag=&estagid=&Currency=&Exchange=&minRoomId=0&maskDiscount=0&TmFromList=F&th=119&RoomGuestCount=1,1,0&eleven=573c4df76400696c0f50224f3feea79e894d093dbe66ed9a281dc762444f01a0&callback=CASHLJQCOMFKWXCzzML&_=1555901561986`

è¿™ä¸ª URL è·å¾—çš„ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ¬¡çš„å‚æ•°æœ‰ç‚¹å¤šï¼Œå‰”é™¤æœ‰è¯­ä¹‰å«ä¹‰çš„ï¼Œä¸ä¼šå˜çš„ï¼Œåªå‰©ä¸‹æœ€åä¸‰ä¸ªå‚æ•°

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555902084522-babef171-3f26-4d71-a4d5-91f426af4f7d.png)

åŒæ ·ç»è¿‡æµ‹è¯•ï¼Œå‘ç° Cookie å¯¹è¯·æ±‚æ²¡æœ‰å½±å“

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555902084558-3a1734e1-3bdf-4448-a164-0b384348695e.png)

ç„¶åè¿˜æ˜¯ç­› jsï¼Œå‘œå‘œå‘œï¼ŒçœŸ TM çš„å¤šï¼Œblock ä¹‹å‰å¤§æ¦‚ 59 ä¸ª jsï¼Œæœ€åä¸»è¦æ˜¯ä¸¤ä¸ª js åœ¨èµ·ä½œç”¨

- `https://webresource.c-ctrip.com/ResHotelOnline/R8/search/js.merge/showhotelinformation.js?releaseno=2019-04-20-10-34-30`
- `https://hotels.ctrip.com/domestic/cas/oceanball?callback=CASkcfYhfhvxJljvZR&_=1555901561840`

æ ¹æ®æ—¶é—´æˆ³ï¼Œ20 å·ä¹Ÿå°±æ˜¯å‰å¤©ï¼Œå‘¨å…­ï¼Œ**æºç¨‹ 996 çŸ³é”¤äº†** ğŸ™ˆ(`showhotelinformation`è¿™ä¸ªæ–‡ä»¶å®é™…ä¸Šæ˜¯å‰ç«¯å’Œåçˆ¬å·¥ç¨‹å¸ˆå…±ç”¨çš„æ–‡ä»¶ï¼Œç›®æµ‹åº”è¯¥æ˜¯å‰ç«¯åšäº†ä¿®æ”¹)

ä¹Ÿæ­£æ˜¯è¿™ä¸ªåŸå› ï¼Œ`showhotelinformation`æ–‡ä»¶é•¿è¾¾ 8k å¤šè¡Œï¼Œæˆ‘çš„ Vscode éƒ½å¡æ­»äº†ï¼ˆVScode åƒåœ¾ï¼Œè¿˜æ˜¯ Sublime é¦™), å½“ç„¶è¿™æ ·ä¹Ÿä»¥ä¸ºè¿™è¿™ä¸ª js ä¸ä¼šæœ‰å¤ªå¤šæ··æ·†ï¼ˆæ˜æ˜å°±æ²¡æœ‰ï¼‰

ä¸ºäº†èŠ‚çœå¤§å®¶æ—¶é—´ï¼Œç›´æ¥æœ`getDetailHotel`ï¼Œç„¶åå¾€ä¸Šçœ‹å°±å¯ä»¥çœ‹åˆ° Url æ‹¼æ¥çš„å…¥å£å‡½æ•°`getRoomHtml`

æˆ‘ä»¬å‘ç°ä»–é€šè¿‡è¯» html ä¸€äº›æ ‡ç­¾æ¥æ„é€ å‚æ•°ï¼Œä¹Ÿå¯ä»¥ç†è§£ï¼Œæ¯•ç«Ÿé‚£ä¹ˆå¤šä¸ªé…’åº—è¯¦æƒ…é¡µå‘¢ï¼Œå¾—å†™çš„é€šç”¨ä¸€ç‚¹

ç„¶åè°ƒç”¨äº†`getHotelDetail`ä¼ äº†æ‹¼æ¥å¥½çš„ URL å’Œä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œç»§ç»­çœ‹

```js
getHotelDetails: a,
function a(e, t) {
    $.BizMod.Promise(n).any(function (i) {
        console.log(i);
        i && (e += "&eleven=" + encodeURIComponent(i)),
            o(e, t)
    })
```

å¯ä»¥çœ‹åˆ°è¿™è¾¹é€šè¿‡ä¸€ä¸ª Promise çš„å›è°ƒå‡½æ•°æ¥è·å¾—äº† eleven å‚æ•°ï¼Œé‚£ä¹ˆå…³é”®å°±åœ¨è¿™ä¸ª n çš„å‡½æ•°ä¸­

```js
function n(t) {
    var o, i = e(15), n = !1; // callbackéšæœº15ä½å­—ç¬¦
    for (; i in window;) // å»windowé‡Œé¢å å‘ï¼Œç”¨äºåé¢çš„å›è°ƒå‡½æ•°
        i = e(15);
    o = hotelDomesticConfig.cas.OceanBallUrl + "?callback=" + i + "&_=" + (new Date).getTime(),
        window[i] = function (e) {
            var o = "";
            try {o = e()
            } catch (i) {
            } finally {
                t.resolve(o)
            }
        },
        $.loader.js(o, { // è°ƒç”¨å°è£…çš„cQueryçš„loader js
            onload: function () {
                setTimeout(function () {n || t.reject("")}, 5e3)
            },
            onerror: function (e) {e && (window[i] = void 0),t.reject("")}
        })
}

function e(e) { // å°±æ˜¯éšæœºç”ŸæˆæŒ‡å®šé•¿åº¦å­—ç¬¦ä¸², å…³é”®åº”è¯¥æ˜¯å­—ç¬¦é•¿åº¦
    for (var t = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"], o = "CAS", i = 0; i < e; i++) {
        var n = Math.ceil(51 * Math.random());
        o += t[n]
    }
    return o
}
```

ä¹Ÿå°±æ˜¯ é€šè¿‡éšæœºç”Ÿæˆ callbackï¼Œè¯·æ±‚ oceanball è¿™ä¸ª URL æ¥è·å¾— eleven

lz å½“æ—¶ä¹Ÿæ˜¯è¿™ä¹ˆå¤©çœŸçš„ï¼Œç›´åˆ°æˆ‘çœ‹äº†ä¸€ä¸‹è¿”å›çš„ js

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555903953409-9f26a0f5-c59f-4f82-aa1a-6d4bf3e9fbf1.png)

ä½ å¯ä»¥ä»å³è¾¹çš„é¢„è§ˆæ¡æ„Ÿå—åˆ°è¿™ä¸ªçš„ææ€–

å…¶å®é€»è¾‘è¶…çº§ç®€å•ï¼Œç”¨ String.formCharCode æŠŠé‚£ä¹ˆé•¿çš„æ•°ç»„è½¬æˆ js ä»£ç ï¼Œç„¶åå†ç”¨ eval ç¼–è¯‘è¿™ä¸ª js ä»£ç 

é‚£æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼ŒUnicode2Char ä¹‹åçš„ä»£ç é•¿ä»€ä¹ˆæ ·å­

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555904106996-ffd6b361-d613-46c8-8218-364f06c67d11.png)

åŒæ ·çš„åšä¸€æ¬¡è§£æ··æ·†ï¼ŒæŠŠè¿‡é•¿çš„ä¸å«è¯­ä¹‰çš„å˜é‡åšä¸€ä¸ªæ›¿æ¢ï¼Œå¾—åˆ°

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555904196200-9a03b246-a4f9-45fa-ac39-b2ca48296d43.png)

å¯ä»¥çœ‹åˆ°æœ€åä¸€è¡Œï¼Œå‡ºç°äº†æˆ‘ä»¬åˆšæ‰çš„é‚£ä¸ªéšæœºç”Ÿæˆçš„`callback`å˜é‡ï¼Œæœç„¶ä»–åœ¨è¿™é‡Œï¼Œä½œä¸ºä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œéœ€è¦ window æœ‰å£°æ˜ `window[callback]` è¿™ä¸ªå˜é‡

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦çš„ eleven å°±æ˜¯ä¸Šé¢çš„ a52ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 408 è¡Œåšçš„ä¸€ä¸ª String.fromCode æ“ä½œ

å¥½åšåˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘å·²ç»å¤§æ¦‚æ˜ç™½äº†ï¼Œæƒ³ä¹Ÿç”¨ä¹‹å‰çš„åŠæ³•ç”¨ jsdom åŠ  node ç¼–è¯‘åšä¸€ä¸ªï¼Œ

ç»è¿‡ä¸€ç³»åˆ—è°ƒè¯•ï¼Œç»“æœæˆ‘ç«Ÿç„¶æ‹¿åˆ°äº†ä¸€å¥å…·æœ‰è¯­ä¹‰çš„å­—ç¬¦ï¼Œç«Ÿç„¶è¿˜æ˜¯ä¸­æ–‡ï¼Œè¿™å°±è·Ÿåšåäº‹è¢«äººå‘ç°ä¸€æ ·ï¼Œæƒ¶ææƒ¶æ

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555907913480-5d5ca694-f788-424c-9230-2889043cfeac.png)

ä¸å¾—ä¸è¯´ï¼Œæºç¨‹åœ¨è¿™ä¸Šé¢è¿˜æ˜¯åšäº†æŒºå¤šå·¥ä½œçš„ï¼Œé¦–å…ˆä¸‰å±‚æ··æ·†ï¼Œæ‹¿åˆ°è¿™ä¸ª js çš„æœ¬æ¥å°±å·²ç»æ¯”è¾ƒéš¾äº†ï¼Œè¿˜åšäº† node this çš„æ¬ºéª—ï¼Œé˜²æ­¢ä½ ç›´æ¥è¿è¡Œè¿™æ®µä»£ç æ¥è·å– eleven

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555906163089-eba0edcd-2148-4d64-9946-528b24870ed8.png)

å…¶æ¬¡é™¤äº†è¿™ç‚¹ï¼Œä»–åœ¨ä»£ç é‡Œè¿˜åšäº†å¾ˆå¤šæ•ˆéªŒï¼Œä½  User-Agent ä¸åŒæ‹¿åˆ°çš„ elven ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œè¿˜ä¼šæ•ˆéªŒ`location.url`ï¼Œ`navigation.href`ï¼Œè¿˜ä¼šå»çœ‹ä½ èƒ½ä¸èƒ½ createElementï¼Œæœ‰å¤šå°‘ä¸ª Element

å…¶æ¬¡ï¼Œè¿™ä¸ª OceanBall æ˜¯åŠ¨æ€è¯·æ±‚è·å¾—çš„ï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹ referer åšçš„æ•ˆéªŒï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å…¶å®ä»–è¿™ä¸ª js æœ‰å¥½å‡ ä¸ªç‰ˆæœ¬ï¼Œé˜²æ­¢ä½ åªåˆ†æä¸€ä¸ªï¼Œ

[å…·ä½“ä»£ç è¯¦è§](https://github.com/iofu728/spider/blob/master/ctrip/hotelDetail.py) å¯¹æºç¨‹æˆ‘å°±åªçˆ¬äº†ä¸€ä¸ªé¡µé¢ï¼Œå› ä¸ºæœ€è¿‘å¯¹è¿™éƒ¨åˆ†æ•°æ®æ²¡ä»€ä¹ˆéœ€æ±‚ï¼Œä¹Ÿä¸æ‰“ç®—ä½¿åŠ²æ€¼äº†ï¼Œæˆå¹´äººè¦ç›¸äº’ä½“è°… å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ

å¾—åˆ°çš„ç»“æœ

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1555906163081-77c902ad-643a-4e46-8489-ed323a964261.png)

å…¶å®ä½ å†ç”¨å¿ƒä¸€ç‚¹è¿˜èƒ½å‘ç°ä¸€äº›å¾ˆå¥‡å¦™çš„ä¸œè¥¿ï¼Œæ¯”å¦‚è¯´æºç¨‹å¥½åƒè¿˜å’Œåä½æœ‰å¹¿å‘Šåˆä½œä»€ä¹ˆçš„ hhh

å¥½å“©ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°±è®²å®Œäº†ï¼Œæ¬¢è¿ç»™æˆ‘è¯„è®ºäº¤æµï¼Œè°¢è°¢ ğŸ‘¹
