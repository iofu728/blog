---
title: ä½ å·²ç»æ˜¯ä¸€ä¸ªæˆç†Ÿçš„çˆ¬è™«äº†ï¼Œåº”è¯¥å­¦ä¼šè‡ªå·±å»å¯¹æŠ—åçˆ¬ç å†œäº†ğŸ™Š-ã€çˆ¬è™«è¿›é˜¶æŒ‡å—ã€
date: 2019-04-06 09:52:11
tags: [Spider]
description: çˆ¬è™«è¿›é˜¶æŠ€å·§
---

> update 19.5.7 QA ä¸€ä¸‹http://www.66ip.cn/ é¦–æ¬¡è¿›å…¥çš„ js é€†å‘æ€è·¯
> update 19.4.21 æ›´æ–°äº†ä¸€ç¯‡å…³äº js é€†å‘çš„æ–‡ç«  [ç©¶ç«Ÿæ˜¯é“å¾·çš„æ²¦ä¸§ï¼Œè¿˜æ˜¯ç°å®çš„éª¨æ„Ÿï¼Œè®©æºç¨‹åçˆ¬å·¥ç¨‹å¸ˆåœ¨ä»£ç é‡Œå†™ä¸‹è¿™å¥è¯-ã€çˆ¬è™«è¿›é˜¶ç¬¬äºŒå¼¹ã€](https://wyydsb.xin/Spider/jsdecoder.html)

**QA ç¯èŠ‚**

> Q: @liu wong ä¸€æ®µ js ä»£ç åœ¨æµè§ˆå™¨ä¸Šæ‰§è¡Œçš„ç»“æœå’Œåœ¨ python ä¸Šç”¨ execjs æ‰§è¡Œçš„ç»“æœä¸ä¸€æ ·ï¼Œæœ‰å•¥åŸå› å‘¢ï¼Ÿ http://www.66ip.cn/

> A: ä¸€èˆ¬ eval å·®å¼‚ ä¸»è¦æ˜¯æœ‰ç¼–è¯‘ç¯å¢ƒï¼ŒDOMï¼Œpy ä¸ js çš„å­—ç¬¦è§„åˆ™ï¼Œcontext ç­‰æœ‰å…³
> åƒ 66ip è¿™ä¸ªç½‘ç«™ï¼Œä¸»è¦æ˜¯ä» py ä¸ js çš„å­—ç¬¦è§„åˆ™ä¸åŒ + DOM å…¥æ‰‹çš„ï¼Œå½“ç„¶å®ƒä¹Ÿæœ‰å¯èƒ½æ˜¯æ— æ„çš„(æ¯•ç«Ÿçˆ¬è™«å·¥ç¨‹å¸ˆç”¨çš„ä¸åªæ˜¯ py)
> é¦–æ¬¡è®¿é—® 66ip è¿™ä¸ªç½‘ç«™ï¼Œä¼šè¿”å›ä¸€ä¸ª 521 çš„ responseï¼Œheader é‡Œé¢å¡äº†ä¸€ä¸ª HTTP-only çš„ cookieï¼Œbody é‡Œé¢å¡äº†ä¸€ä¸ª script

```js
var x = "@...".replace(/@*$/, "").split("@"),
  y = "...",
  f = function(x, y) {
    return num;
  },
  z = f(
    y
      .match(/\w/g)
      .sort(function(x, y) {
        return f(x) - f(y);
      })
      .pop()
  );
while (z++)
  try {
    eval(
      y.replace(/\b\w+\b/g, function(y) {
        return x[f(y, z) - 1] || "_" + y;
      })
    );
    break;
  } catch (_) {}
```

> å¯ä»¥çœ‹åˆ° eval çš„æ˜¯ y å­—ç¬¦ä¸²ç”¨ x æ•°ç»„åšäº†ä¸€ä¸ªå­—ç¬¦æ›¿æ¢ä¹‹åçš„ç»“æœï¼Œæ‰€ä»¥æŒ‰é“ç†åº”è¯¥å’Œç¼–è¯‘ç¯å¢ƒæ²¡æœ‰å…³ç³»ï¼Œä½†æŠŠ eval æ”¹æˆ aa ä¹‹åæ”¾åœ¨ py å’Œæ”¾åœ¨ nodeï¼Œchrome ä¸­ç¼–è¯‘ç»“æœå´ä¸ä¸€æ ·
> è¿™æ˜¯å› ä¸ºåœ¨ p æ­£åˆ™\b ä¼šè¢«è½¬ä¹‰ä¸º\x80ï¼Œè¿™å°±ä¼šå¯¼è‡´æ­£åˆ™åŒ¹é…ä¸åˆ°ï¼Œå°±æ›´ä¸å¯èƒ½æ›¿æ¢äº†ï¼Œå¯¼è‡´æˆ‘ä»¬æ‹¿åˆ°çš„ eval_script å®é™…ä¸Šæ˜¯ä¸€ä¸²ä¹±ç 
> è¿™é‡Œç”¨ r'{}'.format(eval_script) æ¥é˜²æ­¢ç‰¹æ®Šç¬¦å·è¢«è½¬ä¹‰
> å‰©ä¸‹çš„å°±æ˜¯ å¯¹æ‹¿åˆ°çš„ eval_script è¿›è¡Œ dom æ›¿æ¢æ“ä½œ
> æ€»çš„æ¥è¯´æ˜¯ä¸€ä¸ªæŒºä¸é”™çš„ js é€†å‘å…¥é—¨ç»ƒæ‰‹é¡¹ç›®, ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¸…æ™°
> å…·ä½“ä»£ç å‚è§[iofu728/spider](https://github.com/iofu728/spider/blob/master/proxy/ip66.py)

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1557240022438-bc891ec5-7bbc-412a-b4d4-f330608d21f0.png)

> -------- åŸæ–‡ä»è¿™é‡Œå¼€å§‹ --------

å› ä¸ºå„ç§åŸå› ï¼Œè¿™æ®µæ—¶é—´åˆå†™äº†å¥½å¤šçˆ¬è™« ~~ï¼ˆä¸åŠ¡æ­£ä¸š åˆ’æ‰ ğŸ˜¶ï¼‰~~ï¼Œä¹Ÿé¡ºå¸¦æ¥ç€è¿™ä¸ªæœºä¼šæ¥æ€»ç»“ä¸€ä¸‹ï¼Œè‡ªå·±è®¤ä¸ºçš„çˆ¬è™«`è¿›é˜¶`æŠ€å·§

> ps: çˆ¬è™«åƒä¸‡æ¡ï¼Œå…‹åˆ¶ç¬¬ä¸€æ¡ã€‚æˆ‘ä»¬ä¹Ÿè¦ç…§é¡¾ä¸€ä¸‹åçˆ¬å·¥ç¨‹å¸ˆçš„æ„Ÿå—ï¼Œå…‹åˆ¶å¼€å¤šçº¿ç¨‹ï¼Œé™ä½å¹¶å‘æ•°

[ä»¥ä¸‹ä»£ç å·²å¼€æºï¼ŒåŸºæœ¬æ”¯æŒå¼€ç®±å³ç”¨ï¼Œè‡ªå¸¦é«˜å¯ç”¨ä»£ç† IP æ± ï¼Œå‘œå‘œå‘œï¼ˆå¼€æºä¸€æ—¶çˆ½ï¼Œä¸€ç›´å¼€æºä¸€ç›´çˆ½ ğŸ¤§](https://github.com/iofu728/spider)

## å¼€èƒƒèœ->`å­—ä½“`

è¿™åŸºæœ¬ä¸Šå·²ç»æˆäº†åçˆ¬è™«å·¥ç¨‹å¸ˆæœ€æ‹¿æ‰‹ï¼Œæœ€å¸¸è§çš„ä¸€æ‹›äº†ã€‚

åƒçŒ«çœ¼ï¼Œä¸œæ–¹è´¢å¯Œï¼Œå®ä¹ åƒ§ï¼Œå¤©çœ¼æŸ¥ï¼Œèµ·ç‚¹ï¼Œetc.

ç®€å•ä¸€ç‚¹çš„æ¯æ¬¡è¿”å›ä¸€ä¸ªéšæœºå­—ä½“(è¿™ä¸ªéšæœºæŒ‡çš„æ˜¯`å­—å½¢`å’Œ`å­—ç¬¦æ˜ å°„`å…³ç³»éšæœºï¼Œå­—å½¢ setï¼Œå­—ç¬¦ set è¿˜æ˜¯ä¸å˜çš„)

åšçš„ç‹ ä¸€ç‚¹çš„å°±è¿å­—åº“ä¹Ÿéšæœºä¸€ä¸‹(æ˜¯ä¸ªç‹ äººï¼Œè¿™ç§è§£å†³èµ·æ¥æˆæœ¬å°±æœ‰ç‚¹é«˜äº†

åçˆ¬çš„åŸºæœ¬åŸç†å°±æ˜¯åˆ©ç”¨å­—ä½“åº“ä¸­ä¸å¤ªå¸¸ç”¨çš„ä¸€äº› `é«˜ä½å­—ç¬¦å­—æ®µ`(æ¯”å¦‚è¯´ `0xEFFF`) ï¼Œå®ƒæ˜¯`uint16`ã€‚

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1554522481763-f556dc21-cdd8-44f5-93bf-a5c13165fb17.png)

æŠŠ`åŸå§‹æ–‡æœ¬`æ›¿æ¢æˆè¿™äº›`é«˜ä½å­—ç¬¦`ï¼Œç„¶åä½¿ç”¨è‡ªå®šä¹‰çš„ä¸€ä¸ª font è¡¨ç¤ºé«˜ä½å­—ç¬¦å’Œå­—å½¢ä¹‹é—´çš„å…³ç³»

å­—å½¢çš„è¡¨ç¤ºæ–¹å¼ï¼Œæ„Ÿæ€§çš„æƒ³è±¡ä¸€ä¸‹ï¼Œå¤§æŠµå°±æ˜¯ç”¨ç±»ä¼¼ svg ä¹‹ç±»çš„`åæ ‡ç‚¹é›†åˆ`çš„æ–¹å¼æ¥è¡¨ç¤º

ä½†æ€»æ˜¯å»åŒ¹é…è¿™å¾ˆé•¿çš„ä¸€ä¸²åæ ‡ç‚¹æ¥åˆ¤æ–­æ˜¯ä»€ä¹ˆå­—å½¢å°±æ˜¾å¾—å¾ˆä½èƒ½ï¼Œå°±éœ€è¦æœ‰ä¸€ä¸ªèƒ½è¡¨ç¤º`å­—å½¢çš„ç´¢å¼•`ï¼Œäºæ˜¯å°±æœ‰ `Glyph index`,
ç„¶åè¿˜æœ‰ä¸€å¤§å †è¡¨å’Œè§„åˆ’ï¼Œ æ¯”å¦‚ç”¨çš„æœ€å¤šçš„`camp`è¡¨ï¼Œ æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [cmap â€” Character to Glyph Index Mapping Table](https://docs.microsoft.com/en-us/typography/opentype/spec/cmap)

`å­—å½¢ç´¢å¼•å€¼`ä¸€èˆ¬æ˜¯ `Unicode`ï¼Œä½†è¦æ³¨æ„ä¸åŒçš„å­—å½¢å¯èƒ½å­—å½¢ç´¢å¼•å€¼ä¸€æ ·(ç›¸å½“äºå‘ç”Ÿäº† `hash ç¢°æ’`)

åœ¨å®æ“ä¸­ï¼Œåˆ©ç”¨ `fonttools` çš„åŒ…å¯ä»¥è§£æå‡ºæ¥`å­—ç¬¦ç¼–ç ` uint16 å’Œ`å­—å½¢ç´¢å¼•` Unicode ä¹‹é—´çš„æ˜ å°„å…³ç³»

```python
from fontTools.ttLib import TTFont
font_map = TTFont(font_name).getBestCmap() # uint16 -> unicode
```

ä¸€èˆ¬åƒè¿™ç§ï¼Œæ“ä½œçš„å­—ç¬¦é›†ä¸ä¼šå¤ªå¤§ï¼Œæ¯•ç«Ÿå¤ªå¤§å¯¹è‡ªå·±æœåŠ¡ä¹Ÿæ˜¯ä¸€ä¸ªä¸å°çš„å‹åŠ›

å¸¸è§çš„æœ‰æ•°å­—æ›¿æ¢ï¼Œéƒ¨åˆ†æ–‡å­—æ›¿æ¢ï¼Œåƒè¿™ç§åçˆ¬æ¨¡å¼ï¼Œåˆ©ç”¨ seleniumï¼Œsplashï¼Œmitm ä¹‹ç±»çš„éç½‘ç»œè¯·æ±‚åº“å°±æ²¡æœ‰ä»€ä¹ˆæ•ˆæœäº† hhh

å› ä¸ºè¦è€ƒè™‘åˆ°éšæœº fontï¼Œå³å­—ç¬¦ uint16 å’Œå­—å½¢ç´¢å¼• unicode ä¹‹é—´çš„å…³ç³»å‘ç”Ÿæ”¹å˜ï¼Œä½†å­—å½¢å’Œå­—å½¢ç´¢å¼• unicode ä¹‹é—´çš„å…³ç³»ä¸€èˆ¬ä¸ä¼šå˜ã€‚

So, æˆ‘ä»¬å°±å¯ä»¥å»ºç«‹ä¸€ä¸ªå·²çŸ¥çš„å­—å½¢ç´¢å¼• Unicode ä¸åŸå§‹å­—ç¬¦ str ä¹‹é—´çš„å¯¹åº”å…³ç³» dict_base

å½“ font å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ å­—å½¢ç´¢å¼• Unicode å’Œ uint16 å­—ç¬¦ä¹‹é—´çš„å…³ç³»å‘ç”Ÿæ”¹å˜ï¼Œæ ¹æ® dict_base åæ¨å‡ºå­—ç¬¦ uint16 å’ŒåŸå§‹å­—ç¬¦ str ä¹‹é—´çš„å…³ç³»

ä¸¾ä¸ª ğŸŒ°, æ¯”å¦‚è¯´çˆ¬`ä¸œæ–¹è´¢å¯Œ`(ä¸ªäººè§‰å¾—è¿™æ˜¯ä¸€ä¸ªç‰¹åˆ«é€‚åˆå…¥é—¨çš„ç½‘ç«™ï¼Œä»–ä»£ç `å¯è¯»æ€§`æ¯”è¾ƒå¼ºï¼Œæ³¨é‡Šæ¯”è¾ƒå¤š hhh å¾ˆçœŸå® ä¸çŸ¥é“ä»–ä»¬å‰ç«¯éƒ½æ˜¯æ€ä¹ˆæƒ³çš„)

å½“ç„¶`ä¸œæ–¹è´¢å¯Œ`ä¸æ˜¯æ‰€æœ‰é¡µé¢éƒ½é‡‡ç”¨äº† font æ¬ºéª—ï¼Œåº”è¯¥ä¹Ÿæ˜¯å‡ºäºæ•ˆç‡è€ƒè™‘ï¼Œä»¥[http://data.eastmoney.com/bbsj/201806/lrb.html](http://data.eastmoney.com/bbsj/201806/lrb.html)ä¸ºä¾‹

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1554528163496-faa6ee3e-9db3-4de0-b821-689f6be2d23e.png)

å¯ä»¥çœ‹è§ä½¿ç”¨äº†ä¸€ä¸ªå«åš`stonefont`çš„ font æ¥å®ç°å­—ç¬¦åˆ°å­—å½¢çš„æ˜ å°„

ç»è¿‡åˆ†æå¯ä»¥å‘ç°ï¼Œtable é‡Œé¢çš„æ•°æ®éƒ½æ˜¯é¢„å…ˆå­˜æ”¾åœ¨ html çš„ script é‡Œé¢ï¼Œç›´æ¥è¯» json çš„ï¼Œå…¶æ ¼å¼å³å·²ç»åŠ å¯†è¿‡åçš„ uint16 å­—ç¬¦

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1554530970496-4e097b98-077e-460f-81da-ceddcc61d33c.png)

æ—¢ç„¶å·²ç»çŸ¥é“äº†æ‹¿åˆ°çš„æ•°æ®æ˜¯å·²ç»è¢«æ›¿æ¢çš„å­—ç¬¦ï¼Œé‚£ä¹ˆæ‰¾åˆ° css:stonefont æ‰€å¼•ç”¨çš„å­—ä½“ï¼ŒæŠŠå­—ä½“ load éƒ½æœ¬åœ°åˆ†æå¯¹æ¯”å…¶æ˜ å°„å…³ç³»å³å¯

å› ä¸ºå­—ä½“æ˜¯éšæœºæŒ‡æ´¾çš„ï¼Œé‚£ä¹ˆ font_url å°±ä¸€å®šä¸ä¼šè¢«å†™æ­» css ä¸­ ä¸ºäº†ä½¿å¾—é¦–æ¬¡åŠ è½½æ—¶é—´å°½é‡çŸ­ä¹Ÿä¸€èˆ¬ä¸ä¼šé€šè¿‡ `XHR` æ¥è·å¾—ï¼Œä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨ html çš„ script é‡Œé¢åŠ¨æ€ `compile` ç”Ÿæˆ

åœ¨æœ¬ä¾‹ä¸­ï¼Œfont_url å’Œ data å­˜æ”¾åœ¨ä¸€èµ·ï¼Œéƒ½åœ¨ html çš„ script ä¸­ã€‚

```python
url = 'http://data.eastmoney.com/bbsj/201806/lrb.html'
req = requests.get(url, headers=header, timeout=30) # need headers
origin_str = req.text

''' parse json '''
begin_index = origin_str.index('defjson')
end_index = origin_str.index(']}},\r\n')
json_str = origin_str[begin_index + 9:end_index + 3]
json_str = json_str.replace('data:', '"data":')
                   .replace('pages:', '"pages":')
                   .replace('font:', '"font":')
json_req = json.loads(json_str)
font_url = json_req['font']['WoffUrl']
```

åœ¨ç»è¿‡ä¸Šé¢è„šæœ¬è§£æå‡ºæ¥çš„ json ä¸­ï¼Œlz ç«Ÿç„¶æƒŠå¥‡çš„å‘ç°ä¸€ä¸ªç¥å¥‡çš„ä¸œè¥¿

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1554532269585-2f663e7f-62ec-4426-84dd-300667c6194a.png)

ç«Ÿç„¶ç›´æ¥æŠŠ origin_data å’ŒåŠ å¯†ä¹‹åçš„å­—ç¬¦ uint16 å¯¹åº”å…³ç³»ç›´æ¥ po å‡ºæ¥ `Excuse meï¼ï¼ï¼` ğŸ˜¯ ç¬¬ä¸€ååº” æ€•ä¸æ˜¯çƒŸé›¾å¼¹å“¦

ä½†æ˜¯ç»è¿‡å¯¹ js ä»£ç çš„è¿½è¸ªï¼Œæˆ‘å¯ä»¥å¾ˆè´Ÿè´£çš„å‘Šè¯‰ä½ ï¼Œè¿™å°±æ˜¯çœŸçš„å¯¹åº”å…³ç³»ï¼Œè‡³äºä»–ä»¬ä¸ºä»€ä¹ˆè¿™ä¹ˆ`å¥‡è‘©`çš„åšï¼Œè¯·å¾€ä¸‹çœ‹:

åŠ¨æ€æŠŠæ•°æ®å¡åˆ°<tb></tb>æ ‡ç­¾ä¸­çš„å·¥ä½œæ˜¯åœ¨`http://data.eastmoney.com/js_001/load_table_data_pc.js?201606021831`ä¸­åšçš„

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1554532901007-2b3198d8-a02a-4ebe-bf27-431d9bcfa9c6.png)

hhh åº·åº·äººå®¶çš„`æ³¨é‡Š`ï¼Œä½ è¿˜å¥½æ„æ€å†™é‚£ç§ç¨€çƒ‚çš„ä»£ç å“‡(lz ä¸‹çº¿äº† è¿‡äºçœŸå® ä½†æ˜¯ç”Ÿäº§ç¯å¢ƒæ”¾è¿™ç§ä»£ç  è¿™ä¸å°±æ˜¯ç»™å¤§å®¶åšæ•™ç§‘ä¹¦çš„å˜› hhh

```js
display: function () {
    var _t = this;
    try {
        if (_t.options.data.font && _t.options.data.font.WoffUrl) { // å»æ‰¾font_map
            _t.options.font = _t.options.data.font;} else {//è®¾ç½®é»˜è®¤}
        _t.loadFontFace(); // update css: stonefont
        var _d = _t.options.data.data, _body = _t.options.tbody;
        var trs = _body.childNodes;
        for (var i = trs.length - 1; i >= 0; i--) {_body.removeChild(trs[i])} // remove tb
        if (_d && _d.length && _d[0].stats == undefined) {
            for (var i = 0; i < _d.length; i++) {
                var data, row = rowTp.cloneNode(true);
                _body.appendChild(row);
                _t.uncrypt(data) // è§£å¯†
                _t.maketr(row, data, i, ((_p - 1) * _ps + 1 + i)); // ä¸Šé¢œè‰²
                _t.crypt(row)   // åŠ å¯†
            }
        }
    }
}
```

æ¥çœ‹ä¸€ä¸‹æŠŠæ•°æ®å¡«å……åˆ° tb è¿™ä¸ªè¿‡ç¨‹çš„`å…¥å£å‡½æ•°`ï¼ˆçœå»äº†ä¸€äº›ä¸å¤ªé‡è¦çš„é€»è¾‘

`ä»jsonä¸­æ‰¾fontä¿¡æ¯` -> `åŠ¨æ€ä¿®æ”¹css:stonefont` -> `åˆ é™¤tbå­æ ‡ç­¾` -> `è§£å¯†æ•°æ®(uncrypt)` -> `ç»™æ•°æ®åŠ æ ·å¼(maketr)` -> `å¯¹åŠ å®Œæ ·å¼çš„æ–‡æœ¬é‡æ–°åŠ å¯†(crypt)` -> `å¡å›tbæ ‡ç­¾`

ä¸€å¼€å§‹ï¼Œæˆ‘çœ‹åˆ°è§£å¯†å†åŠ å¯†è¿™ä¸ªè¿‡ç¨‹æ˜¯æ‡µé€¼çš„ï¼Œ'éš¾ä¸æˆåŠ å¯†è§£å¯†ç”¨çš„ä¸æ˜¯ä¸€ä¸ªç§˜é’¥'ã€‚çœ‹åˆ°åé¢æˆ‘å‘ç°æˆ‘é”™äº†ï¼Œä¸¤ä¸ª font_map ä¸€æ¯›ä¸€æ ·å‘€

åˆ†æä¸€ä¸‹ï¼Œå½“æ—¶ä»–ä»¬åŠ è¿™ä¸ªåº”è¯¥æ˜¯å‰ç«¯ä¸å¤ªå¥½å¤„ç†æ ·å¼é—®é¢˜ï¼Œå¼„çš„ä¸€ä¸ªæŠ˜ä¸­æ–¹æ¡ˆï¼ˆå¯¹å—ï¼Œå‰ç«¯ä¹Ÿæ²¡åŠæ³•è§£æ font å†…çš„æ˜ å°„å…³ç³»

å…¶å®åŠ ä¸€ä¸ªæ˜ å°„å…³ç³»ä¸å˜çš„`æ­£è´Ÿæ ‡å¿—ä½`ä¸å°±å¥½äº†(æ¯•ç«Ÿä½ æ˜¾ç¤ºæ ·å¼ä¸»è¦çœ‹æ•°å­—æ­£è´Ÿå·ï¼Œè¦å¤„ç†æ˜¾ç¤ºä¸‡ï¼Œåƒç­‰ä½æ•°å®Œå…¨å¯ä»¥æ ¹æ®å­—ç¬¦ä½æ•°æ¥

è¿™æ ·æ”¹å®Œå…¨å°±å¤±å»äº†æœ¬æ¥åçˆ¬è®¾ç½®çš„æ•ˆæœï¼Œå½“ç„¶è¿™ç»™äº†å¹¿å¤§è‡´åŠ›äºå­¦ä¹ çˆ¬è™«çš„åŒå­¦ä¸€ä¸ª`å…¥é—¨çš„æœºä¼š` ğŸ˜˜

åˆ†æåˆ°è¿™é‡Œï¼Œç†ä¸‹æ€è·¯ï¼Œ`é€šè¿‡ json è§£æå‡ºçš„ font_map ç”Ÿæˆä¸€ä¸ª base æ˜ å°„å…³ç³»`ï¼ˆå…¶å®ä½ ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ font_map è¿›è¡Œè§£æ hhh

ç„¶å`æ¯æ¬¡æŠŠ font load åˆ°æœ¬åœ°å¯¹æ¯” base æ˜ å°„å…³ç³»ï¼Œç”Ÿæˆè¿™ä¸ªå­—ä½“å¯¹åº”çš„æ˜ å°„å…³ç³»`

å…·ä½“ä»£ç å¯è§[eastmoney.eastmoney](https://github.com/iofu728/spider/blob/master/eastmoney/eastmoney.py)

ç¨å¾®æä¸€ä¸‹è‡ªå·±è¸©çš„ä¸¤ä¸ªå‘

##### error: unpack requires a buffer of 20 bytes

- requests.text -> str,
- `requests.content` -> byte or str

- [Struct.error: unpack requires a buffer of 16 bytes](https://stackoverflow.com/questions/51110525/struct-error-unpack-requires-a-buffer-of-16-bytes)

##### How to analysis font

- åˆ©ç”¨ fonttools åŒ…
- è·å¾— cmap è¡¨ `TTFont().getBestCamp()`
- å’Œ base è¿›è¡Œå¯¹æ¯”

## å†·èœ->`js compile`

è¿™ä¸ªè¯é¢˜ï¼Œå…¶å®æœ€è¿‘[å¦å¤–ä¸€ä¸ª dalao åœ¨çŸ¥ä¹è®²è¿‡](https://zhuanlan.zhihu.com/p/59005948)ï¼Œæˆ‘å°±å¤§æ¦‚æä¸€ä¸‹

ä¸€å¼€å§‹çœ‹åˆ°é‚£ä¸ªé¢è¯•é¢˜[http://shaoq.com:7777/exam](http://shaoq.com:7777/exam)çš„æ—¶å€™ä¹Ÿæ˜¯æ¯”è¾ƒæƒŠå¥‡çš„ï¼Œä»¥å‰é‡åˆ° css é‡Œé¢å¡ä¿¡æ¯çš„è¿˜æ˜¯æ¯”è¾ƒå°‘çš„, ä¸Šä¸€ä¸ªè¿˜æ˜¯ [goubanjiaï¼Ÿï¼Ÿï¼Ÿ](http://www.goubanjia.com/)

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1554539681565-179256d9-117e-47d2-a9e8-b07488ed98ba.png)

åªä¸è¿‡ goubanjia çš„ css æ˜¯é™æ€èµ„æºï¼Œè¿™è¾¹ shaoq ç”¨çš„æ˜¯åŠ¨æ€ç¼–è¯‘ç”Ÿæˆï¼Œå…¶å®è¿˜æ˜¯å·®ä¸å¤šçš„ï¼Œç”¨ä¸€ä¸‹ execjs + jsdom è¿›è¡ŒåŠ¨æ€ç¼–è¯‘ jsï¼Œå¾—åˆ° style

- [æœ‰å…³ goubanjia è§£æçš„å¯ä»¥æŸ¥çœ‹ä¹‹å‰çš„ä¸€ç¯‡åšæ–‡](https://zhuanlan.zhihu.com/p/47786356)

- shaoq çš„æ€è·¯:

`é¦–æ¬¡è¯·æ±‚è·å¾—cookie` -> `è¯·æ±‚image` -> `ç­‰5.5sï¼ˆæ³¨æ„ä¸€å®šæ˜¯è·å¾—htmlå5.5sï¼‰` -> `ç¼–è¯‘js è·å¾—css` -> `å¡cssçš„contentåˆ°å¯¹åº”çš„æ ‡ç­¾ï¼ˆè¿™ä¸€æ­¥éœ€è¦æŠŠä¸€äº›æ— å…³çš„æ ‡ç­¾å‰”é™¤æ‰ï¼‰`

å…·ä½“ä»£ç å¯è§[exam.shaoq](https://github.com/iofu728/spider/blob/master/exam/shaoq.py)

ç„¶åä¹Ÿé™„ä¸€ä¸‹è‡ªå·±è¸©å¾—å‘

##### Can't get true html

- Wait time must be 5.5s.
- So you can use `threading` or `await asyncio.gather` or `aiohttp` to request image

- [Coroutines and Tasks](https://docs.python.org/3/library/asyncio-task.html)

##### Error: Cannot find module 'jsdom'

> jsdom must install in local not in global

- [Cannot find module 'jsdom'](https://github.com/scala-js/scala-js/issues/2642)

##### remove subtree & edit subtree & re.findall

```python
subtree.extract()
subtree.string = new_string
parent_tree.find_all(re.compile('''))
```

- [extract()](https://www.crummy.com/software/BeautifulSoup/bs4/doc/#extract)
- [NavigableString](https://www.crummy.com/software/BeautifulSoup/bs4/doc/#navigablestring)
- [A regular expression](https://www.crummy.com/software/BeautifulSoup/bs4/doc/#a-regular-expression)

## ç”œç‚¹->`websocket`

å…¶å®è¿™ä¸€å—å†…å®¹å°±å’Œ`å‹æµ‹`æœ‰ç‚¹åƒäº†ï¼Œç”¨å¤„ä¸åªæ˜¯ç”¨æ¥çˆ¬å–ä¿¡æ¯ï¼Œå¾ˆå¤šæ—¶å€™æ˜¯ç”¨æ¥`æ¨¡æ‹Ÿé•¿è¿æ¥è¯·æ±‚`

å¦‚æœå¼€å¤šè¿›ç¨‹çš„è¯å®é™…ä¸Šæ•ˆæœå°±æ˜¯å‹æµ‹ websocketï¼ˆæ‰€ä»¥å¤§å®¶`æ‚ ç€ç‚¹`

> é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯é•¿è¿æ¥, ä»€ä¹ˆæ˜¯ websocketï¼Œä»€ä¹ˆæ˜¯ socket

`socket`ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ª unix çš„æ¦‚å¿µã€‚æˆ‘ä»¬çŸ¥é“è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡é—®é¢˜ç§°ä¹‹ä¸º IPC(InterProcess Communication, IPC)æœ‰ç®¡é“ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¿¡å·é‡ï¼Œå…±äº«å­˜å‚¨ï¼Œå¥—æ¥å­— Socket ç­‰æ–¹å¼

ä½†è¿™äº›éƒ½æ˜¯åœ¨æœ¬æœºèŒƒå›´çš„é€šä¿¡ï¼Œå³ Unix åŸŸå†… IPCï¼Œå¦‚æœæŠŠé—®é¢˜æ‹“å±•åˆ°ç½‘ç»œå†…çš„é€šä¿¡åˆ™å˜æˆäº†`ç½‘ç»œåŸŸå¥—æ¥å­—`

å› ä¸ºç½‘ç»œé€šä¿¡çš„ä¸å¯ä¿¡ï¼Œéœ€è¦åšä¸€ç³»åˆ—çš„`è®¡ç®—æ ¡éªŒå’Œ`ï¼Œ`æ‰§è¡Œåè®®å¤„ç†`ï¼Œ`æ·»åŠ æˆ–åˆ é™¤ç½‘ç»œæŠ¥å¤´`ï¼Œ`äº§ç”Ÿç›¸åº”çš„é¡ºåºå·`ï¼Œ`å‘é€ç¡®è®¤æŠ¥æ–‡`(æ³¨æ„ç†è§£è¿™ä¸€éƒ¨åˆ†å†…å®¹ï¼Œå¯¹åé¢è¯»æ‡‚ã€æ¨¡æ‹ŸäºŒè¿›åˆ¶æŠ¥æ–‡å¾ˆæœ‰å¸®åŠ©)

http æ˜¯ä¸€ç§åŸºäº TCP çš„çŸ­é“¾æ¥ï¼Œä¸‰æ¬¡æ¡æ‰‹ ğŸ¤ ä¹‹åå»ºç«‹è¿æ¥ï¼Œå®Œæˆä»»åŠ¡ä¹‹åï¼Œ`é©¬ä¸Š`å››æ¬¡æ¡æ‰‹ ğŸ¤ å…³é—­è¿æ¥

é•¿è¿æ¥åˆ™æ˜¯åœ¨å®Œæˆä»»åŠ¡ä¹‹å`ä¸ç«‹å³`å…³é—­è¿æ¥ï¼Œè€Œæ˜¯å½“è¿æ¥çš„ä¸€æ–¹é€€å‡ºä¹‹åæ‰å…³é—­è¿æ¥ï¼Œå¸¸è§çš„åè®®æœ‰ websocket å’Œ http çš„é•¿è¿æ¥

æˆ‘ä»¬çŸ¥é“ TCP æ˜¯å¯é çš„è¿æ¥ï¼Œå»ºç«‹è¿æ¥çš„ä»£ä»·æ¯” UDP å¤§å¤šäº†ï¼Œå¦‚æœæœ‰ä¸€ä¸ªéœ€æ±‚éœ€è¦åå¤å»ºç«‹è¿æ¥ï¼Œæ¯”å¦‚è¯´`èŠå¤©`ï¼Œ`ç›´æ’­å¼¹å¹•`æ•°åƒä¸‡ç”¨æˆ·åå¤è¯·æ±‚çŸ­é“¾æ¥ï¼Œä¼šèŠ±è´¹å¤§é‡æ—¶é—´åœ¨åè®®ä¸Š

å¦å¤–ä¹Ÿæ˜¯ä¸ºäº†èƒ½ä½¿å¾—æœåŠ¡å™¨å¯ä»¥`ä¸»åŠ¨`å‘ç”Ÿç»™ç”¨æˆ·æ•°æ®ï¼Œè€Œä¸æ˜¯å®¢æˆ·ç«¯`è½®è¯¢`ï¼Œwebsocket å°±è…¾ç©ºå‡ºä¸–

åœ¨ java ä¸­å»ºç«‹é•¿è¿æ¥å¸¸ç”¨ [`Netty`](https://netty.io/) è§£å†³

åœ¨ py é‡Œé¢å°±å¾—ç”¨ä¸€ä¸‹å¼‚æ­¥ io åº“ `asyncio` å’Œ å¼‚æ­¥ http`aiohttp` (hhh ç«Ÿç„¶è¿˜èµ„ç“· websocket)

å»ºç«‹ websocket è¿æ¥çš„è¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œå…³é”®æ˜¯åˆ†æ `header å¤´éƒ¨å­—èŠ‚`å«ä¹‰

ä¸¾ä¸ª ğŸŒ°ï¼Œæ¯”å¦‚è¯´çˆ¬å– b ç«™ up ä¸»è§†é¢‘çš„`å®æ—¶è®¿é—®é‡`ï¼Œä»¥ 18 å¹´ç™¾å¤§ç¬¬ä¸€çš„`ç‚’é¢ç­‹`ä¸ºä¾‹[https://www.bilibili.com/video/av21061574](https://www.bilibili.com/video/av21061574)

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1554539537545-82a74619-cbfe-4b86-8f53-ca8adabdca79.png)

åˆ†æ network å¯ä»¥å‘ç°è§†é¢‘å·¦ä¸‹è§’çš„ `XX äººæ­£åœ¨çœ‹`ï¼Œ`XX æ¡å®æ—¶å¼¹å¹•`ï¼Œ`æ–°å¢å¼¹å¹•`æ¨é€éƒ½æ˜¯åŸºäº websocket åè®®è¿›è¡Œä¼ è¾“çš„

å†æ¥ä»”ç»†ç ”ç©¶ä¸€ä¸‹å…·ä½“å‘é€çš„å­—èŠ‚ç 

#### `Send`

```
00000000: 0000 005b 0012 0001 0000 0007 0000 0001  ...[............
00000001: 0000 7b22 726f 6f6d 5f69 6422 3a22 7669  ..{"room_id":"vi
00000002: 6465 6f3a 2f2f 3231 3036 3135 3734 2f33  deo://21061574/3
00000003: 3435 3438 3336 3622 2c22 706c 6174 666f  4548366","platfo
00000004: 726d 223a 2277 6562 222c 2261 6363 6570  rm":"web","accep
00000005: 7473 223a 5b31 3030 305d 7d              ts":[1000]}

00000000: 0000 0021 0012 0001 0000 0002 0000 0002  ...!............  30s heart beat
00000001: 0000 5b6f 626a 6563 7420 4f62 6a65 6374  ..[object Object
00000002: 5d                                       ]

00000000: 0000 0021 0012 0001 0000 0002 0000 0003  ...!............
00000001: 0000 5b6f 626a 6563 7420 4f62 6a65 6374  ..[object Object
00000002: 5d                                       ]
...
```

å¯ä»¥çœ‹å‡ºå­—èŠ‚ç ç”¨çš„æ˜¯`å¤§ç«¯`å­—èŠ‚åºï¼Œå‰ `18` ä¸ªå­—èŠ‚æ˜¯ header å¤´ï¼Œç´§è·Ÿç€çš„æ˜¯ body å†…å®¹

| `I`           | `H`           | `H`           | `I`       | `I`       | `H`  |
| ------------- | ------------- | ------------- | --------- | --------- | ---- |
| 0000 005b     | 0012          | 0001          | 0000 0007 | 0000 0001 | 0000 |
| 0000 0021     | 0012          | 0001          | 0000 0002 | 0000 0002 | 0000 |
| 0000 0021     | 0012          | 0001          | 0000 0002 | 0000 0003 | 0000 |
| `socket é•¿åº¦` | `header é•¿åº¦` | `åè®®ç‰ˆæœ¬ï¼Œ1` | `æ“ä½œç `  | `åºåˆ—å·`  | 0    |

æ˜ç™½è¿™ç‚¹ä¹‹åå°±æ¯”è¾ƒå¥½æ„é€ å­—èŠ‚ç äº†ï¼Œå…ˆåˆå§‹åŒ–ä¸€ä¸ª header_struct,ç„¶åå¾€ struct åŠ å…¥æ¯ä¸€éƒ¨åˆ†çš„å†…å®¹

```python
HEARTBEAT_BODY = '[object Object]'
HEADER_STRUCT = struct.Struct('>I2H2IH')

def parse_struct(self, data: dict, operation: int):
    ''' parse struct '''
    if operation == 7:
        body = json.dumps(data).replace(" ", '').encode('utf-8')
    else:
        body = self.HEARTBEAT_BODY.encode('utf-8')
    header = self.HEADER_STRUCT.pack(
        self.HEADER_STRUCT.size + len(body),
        self.HEADER_STRUCT.size,
        1,
        operation,
        self._count,
        0
    )
    self._count += 1
    return header + body
```

éœ€è¦æ³¨æ„çš„æ˜¯å»ºç«‹è¿æ¥æ—¶ï¼Œæ‰€éœ€è¦ room_id å¹¶ä¸åªæ˜¯ av_idï¼Œéœ€è¦å…ˆå» html ä¸­å–ä¸€ä¸‹ cid(å—¯ï¼Œåªèƒ½åœ¨ html ä¸­è§£æï¼Œ`cid` æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§æ¯”è¾ƒé«˜çš„å˜é‡ï¼Œåœ¨åŸºæœ¬ä¸Šåé¢æ‰€æœ‰å˜é‡ä¸­éƒ½ä¼šä½¿ç”¨

```python
def _getroom_id(self, next_to=True, proxy=True):
    ''' get av room id '''
    url = self.ROOM_INIT_URL % self._av_id
    html = get_request_proxy(url, 0) if proxy else basic_req(url, 0)
    head = html.find_all('head')
    if not len(head) or len(head[0].find_all('script')) < 4 or not '{' in head[0].find_all('script')[3].text:
        if can_retry(url):
            self._getroom_id(proxy=proxy)
        else:
            self._getroom_id(proxy=False)
        next_to = False
    if next_to:
        script_list = head[0].find_all('script')[3].text
        script_begin = script_list.index('{')
        script_end = script_list.index(';')
        script_data = script_list[script_begin:script_end]
        json_data = json.loads(script_data)
        if self._p == -1 or len(json_data['videoData']['pages']) < self._p:
            self._room_id = json_data['videoData']['cid']
        else:
            self._room_id = json_data['videoData']['pages'][self._p - 1]['cid']
        print('Room_id:', self._room_id)
```

æ³¨æ„æœ‰äº›è§†é¢‘å¯èƒ½ä¼šæœ‰`å¤šä¸ª page`ï¼Œæ¯ä¸ª page çš„ cid å…¶å®æ˜¯ä¸ä¸€æ ·çš„

#### Receive

```
00000000: 0000 002b 0012 0001 0000 0008 0000 0001  ...+............
00000001: 0000 7b22 636f 6465 223a 302c 226d 6573  ..{"code":0,"mes
00000002: 7361 6765 223a 226f 6b22 7d              sage":"ok"}

00000000: 0000 006f 0012 0001 0000 0003 0000 0002  ...o............ every 30s
00000001: 0000 7b22 636f 6465 223a 302c 226d 6573  ..{"code":0,"mes
00000002: 7361 6765 223a 2230 222c 2264 6174 6122  sage":"0","data"
00000003: 3a7b 2272 6f6f 6d22 3a7b 226f 6e6c 696e  :{"room":{"onlin
00000004: 6522 3a32 3232 2c22 726f 6f6d 5f69 6422  e":222,"room_id"
00000005: 3a22 7669 6465 6f3a 2f2f 3231 3036 3135  :"video://210615
00000006: 3734 2f33 3435 3438 3336 3622 7d7d 7d    74/34548366"}}}

00000000: 0000 007b 0012 0001 0000 0005 0000 0000  ...{............ danmuku 1
00000001: 0000 7b22 636d 6422 3a22 444d 222c 2269  ..{"cmd":"DM","i
00000002: 6e66 6f22 3a5b 2237 312e 3137 2c31 2c32  nfo":["71.17,1,2
00000003: 352c 3136 3737 3732 3135 2c31 3535 3435  5,16777215,15545
00000004: 3339 3238 322c 3136 3739 3335 3332 332c  39282,167935323,
00000005: 302c 6562 3636 3033 6161 2c31 3433 3633  0,eb6603aa,14363
00000006: 3937 3436 3136 3231 3936 3530 222c 22e8  974616219650",".
00000007: 9e8d e58c 96e4 bda0 225d 7d              ........"]}

00000000: 0000 0079 0012 0001 0000 0009 0000 0000  ...y............ danmuku2
00000001: 0000 0000 0067 0012 0001 0000 03e8 0000  .....g..........
00000002: 0000 0000 5b22 3731 2e31 372c 312c 3235  ....["71.17,1,25
00000003: 2c31 3637 3737 3231 352c 3135 3534 3533  ,16777215,155453
00000004: 3932 3832 2c31 3637 3933 3533 3233 2c30  9282,167935323,0
00000005: 2c65 6236 3630 3361 612c 3134 3336 3339  ,eb6603aa,143639
00000006: 3734 3631 3632 3139 3635 3022 2c22 e89e  74616219650","..
00000007: 8de5 8c96 e4bd a022 5d                   ......."]
```

å¯ä»¥çœ‹å‡º header ç»“æ„å’Œ send ä¸€æ¯›ä¸€æ ·ï¼Œé™¤äº†æ”¶åˆ° danmuku çš„æ—¶å€™`åºåˆ—å·`ä¸º 0(è¿™ä¸€ç‚¹ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºä¸æ˜¯ä¸»åŠ¨å®¢æˆ·ç«¯å‘é€å¾—åˆ°çš„è¿”å›ï¼Œè€Œæ˜¯æœåŠ¡ç«¯ä¸»åŠ¨`æ¨é€`ç»™å®¢æˆ·ç«¯çš„)

- å¯ä»¥çœ‹åˆ°å½“ `operation=3` çš„æ—¶å€™ï¼Œæ”¶åˆ°äº†å®æ—¶åœ¨çº¿äººæ•°
- å½“ `operation=5` æ—¶æ”¶åˆ°ä¸€ä¸ª body é‡Œé¢å¸¦ä¸€ä¸ª json çš„ commondï¼Œå…¶ä¸­çš„`cmd`å†…å®¹è¡¨ç¤ºå…·ä½“çš„ç±»åˆ«
- å½“ `operation=9` çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯ä¸¤ä¸ªåµŒå¥—å­—èŠ‚ç ï¼Œé‡Œé¢é‚£ä¸ª `operation=0x03e8=1000`, é‡Œé¢å­˜æ”¾çš„æ˜¯ä¸€ä¸ª list

æ€»ç»“ä¸€ä¸‹ operation

| æ“ä½œç  | å«ä¹‰                     |
| ------ | ------------------------ |
| 2      | å‘é€`å¿ƒè·³åŒ…`             |
| 3      | `åœ¨çº¿`æ•°æ®               |
| 5      | `cmd` æ¨¡å¼ å…·ä½“çœ‹['cmd'] |
| 7      | `å»ºç«‹`è¿æ¥               |
| 8      | è¿æ¥å»ºç«‹æˆåŠŸ             |
| 9      | `åµŒå¥—`header             |
| 1000   | `danmuka` list           |

çœ‹ä¸‹æ•ˆæœ

![image](https://cdn.nlark.com/yuque/0/2019/png/104214/1554544252927-4a27c1cd-4437-47f5-aef1-fccd2b9b525c.png)

å…·ä½“ä»£ç å¯è§[bilibili/bsocket.py](https://github.com/iofu728/spider/blob/master/bilibili/bsocket.py)

å¦å¤–å¼€å‘äº†ä¸€å¥—æ ¹æ®æ’è¡Œæ¦œçˆ¬å– up æ—¶åºç´¯è®¡æ•°æ®ï¼Œé™„å¸¦ç›‘æ§è¯„è®ºå†…å®¹çš„ç³»ç»Ÿï¼Œå¯ç”¨äºåˆ†æ b ç«™è§†é¢‘è¯„åˆ†åŸç†çš„åˆ†æï¼Œæ”¯æŒå¼€ç®±å³ç”¨ï¼Œ[æ¬¢è¿ star](https://github.com/iofu728/spider/blob/master/bilibili/bilibili.py)

å¦‚æœæœ‰åš b ç«™ç›´æ’­æ•°æ®çš„çˆ¬å–å¯ä»¥å‚è€ƒ[å¦å¤–ä¸€ä½ dalao çš„åšå®¢](https://blog.csdn.net/xfgryujk/article/details/80306776)ï¼Œç›´æ’­çš„å­—èŠ‚ç è§„åˆ™ç•¥æœ‰ä¸åŒ

å¥½äº†ï¼Œå¤§æ¦‚çš„çˆ¬è™«è¿›é˜¶æŠ€å·§å°±è¯´åˆ°è¿™ï¼Œæ¬¢è¿å„ä½ dalao æ‰¹è¯„æŒ‡æ­£ï¼Œ`è½¬è½½è¯·è”ç³»åšä¸»`
